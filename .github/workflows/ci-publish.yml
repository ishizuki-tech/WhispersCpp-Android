# ============================================================
# ‚úÖ WhispersCpp-Android ‚Äî CI Publish (v9.9.10 Full Stable)
# ------------------------------------------------------------
# ‚Ä¢ Auto detects latest published GitHub release (fallback if meta not found)
# ‚Ä¢ Always updates Wiki + GitHub Pages (even if artifacts are empty)
# ‚Ä¢ SafeHTML output (YAML-safe heredoc, placeholder substitution)
# ‚Ä¢ Wiki branch auto-detect (master/main both supported)
# ‚Ä¢ Fully validated: no YAML/Bash syntax errors
# ============================================================

name: Android CI Publish (Meta + Pages + Wiki)

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Android CI Build (Detect + Review + Build + Release)"]
    types: [completed]

permissions:
  contents: write
  pages: write

defaults:
  run:
    shell: bash

env:
  EXPECTED_WORKFLOW_NAME: "Android CI Build (Detect + Review + Build + Release)"
  DEFAULT_ARTIFACT_NAME: "release-artifacts"

jobs:
  publish:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')

    steps:
      # ------------------------------------------------------------
      # üß© Checkout repository
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch || github.ref_name }}

      # ------------------------------------------------------------
      # üõ†Ô∏è Install dependencies
      # ------------------------------------------------------------
      - name: üõ†Ô∏è Install dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y jq unzip curl wget

      # ------------------------------------------------------------
      # üîé Resolve workflow_run info
      # ------------------------------------------------------------
      - name: üîé Resolve workflow run
        id: resolve
        run: |
          set -euxo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
            echo "branch=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Using workflow_run from branch: ${{ github.event.workflow_run.head_branch }}"
          else
            echo "üß≠ Manual dispatch ‚Äî no linked run_id."
          fi

      # ------------------------------------------------------------
      # üß† Detect version tag (meta/models.json ‚Üí latest release fallback)
      # ------------------------------------------------------------
      - name: üß† Detect version tag
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve.outputs.run_id || '' }}"
          TAG="manual-run"

          if [ -n "$RUN_ID" ]; then
            mkdir -p _meta
            curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" > _meta/list.json
            META_URL=$(jq -r '.artifacts[] | select(.name=="meta") | .archive_download_url' _meta/list.json | head -n1)
            if [ -n "$META_URL" ] && [ "$META_URL" != "null" ]; then
              curl -sL -H "Authorization: Bearer ${GH_TOKEN}" "$META_URL" -o _meta/meta.zip
              unzip -o _meta/meta.zip -d _meta >/dev/null || true
              TAG=$(jq -r '.version_tag // empty' _meta/models.json || true)
            fi
          fi

          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "üß≠ No meta tag found, fetching latest GitHub release..."
            TAG=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/releases/latest" \
              | jq -r '.tag_name // "unreleased"')
          fi

          echo "version_tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "ü™∂ Final detected tag: $TAG"

      # ------------------------------------------------------------
      # üì¶ Retrieve artifacts or release APKs
      # ------------------------------------------------------------
      - name: üì¶ Retrieve artifacts or release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          mkdir -p artifacts
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve.outputs.run_id || '' }}"

          # Try build artifacts
          if [ -n "$RUN_ID" ]; then
            echo "üîç Fetching artifacts from run: $RUN_ID"
            curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" > artifacts_list.json
            URL=$(jq -r '.artifacts[0].archive_download_url' artifacts_list.json)
            if [ -n "$URL" ] && [ "$URL" != "null" ]; then
              curl -sL -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o artifacts.zip
              unzip -o artifacts.zip -d artifacts >/dev/null || true
            fi
          fi

          # Fallback: latest release assets (.apk)
          if ! compgen -G "artifacts/*.apk" >/dev/null; then
            echo "üß≠ No build artifacts found ‚Äî checking latest GitHub release assets..."
            RELEASE_JSON=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/releases/latest")
            echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name|endswith(".apk")) | .browser_download_url' > release_apks.txt
            if [ -s release_apks.txt ]; then
              while read -r URL; do
                echo "üåê Found release asset: $URL"
                wget -q --content-disposition "$URL" -P artifacts || true
              done < release_apks.txt
            fi
          fi

          echo "üìÇ Artifacts listing (OK if empty):"
          ls -lh artifacts || true

      # ------------------------------------------------------------
      # üåà Generate Wiki + Pages
      # ------------------------------------------------------------
      - name: üåà Generate Wiki + Pages
        run: |
          set -euxo pipefail
          TAG=${{ steps.tag.outputs.version_tag }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages

          # ---------- Wiki ----------
          {
            echo "# üì¶ WhispersCpp-Android (${TAG})"
            echo "Updated: ${DATE}"
            echo
            echo "## üß© Build Artifacts"
            if compgen -G "artifacts/*.apk" >/dev/null; then
              for f in artifacts/*.apk; do
                N=$(basename "$f")
                echo "- [$N](https://github.com/${REPO}/releases/download/${TAG}/${N})"
              done
            else
              echo "_No APK artifacts found._"
            fi
            echo
            echo "## üîó GitHub Pages"
            echo "${BASE_URL}"
          } > wiki/Downloads.md

          echo "----- DEBUG: wiki/Downloads.md -----"
          cat wiki/Downloads.md || true
          echo "------------------------------------"

          # ---------- Pages (Safe HTML) ----------
          cat > gh-pages/index.html <<'HTML'
            <!doctype html>
            <html lang="en">
            <head>
              <meta charset="utf-8"/>
              <meta name="viewport" content="width=device-width,initial-scale=1"/>
              <title>üì¶ WhispersCpp-Android Downloads</title>
              <style>
                body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0b0f17;color:#e8e8e8;margin:0}
                .wrap{max-width:960px;margin:0 auto;padding:36px}
                .glass{background:rgba(255,255,255,0.08);border-radius:20px;box-shadow:0 12px 45px rgba(0,0,0,0.35);backdrop-filter:blur(14px);padding:28px}
                h1{margin:0 0 8px 0}
                .meta{opacity:.9}
                table{width:100%;border-collapse:collapse;margin-top:16px}
                th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.12);text-align:left}
                tr:hover{background:rgba(255,255,255,0.05)}
                a{color:#7bdcff;text-decoration:none}
                a:hover{text-decoration:underline}
                .qr{margin:10px 0 0}
                footer{margin-top:22px;font-size:.9em;color:#aaa}
              </style>
            </head>
            <body>
              <div class="wrap">
                <div class="glass">
                  <h1>üì¶ WhispersCpp-Android</h1>
                  <div class="meta">Tag: TAG_PLACEHOLDER ‚Ä¢ Updated: DATE_PLACEHOLDER</div>
                  <div class="qr">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=BASE_URL_PLACEHOLDER" width="110" height="110" alt="QR">
                  </div>
                  <table>
                    <tr><th>File</th><th>Size</th></tr>
          HTML

          if compgen -G "artifacts/*.apk" >/dev/null; then
            for f in artifacts/*.apk; do
              N=$(basename "$f")
              S=$(du -h "$f" | cut -f1)
              printf "<tr><td><a href='https://github.com/%s/releases/download/%s/%s'>%s</a></td><td>%s</td></tr>\n" \
                "$REPO" "$TAG" "$N" "$N" "$S" >> gh-pages/index.html
            done
          else
            echo "<tr><td colspan='2'><em>No APK files found in artifacts or latest release.</em></td></tr>" >> gh-pages/index.html
          fi

          cat >> gh-pages/index.html <<'HTML'
                  </table>
                  <footer>Generated by CI/CD v9.9.10 Full Stable</footer>
                </div>
              </div>
            </body>
            </html>
          HTML

          sed -i "s|BASE_URL_PLACEHOLDER|${BASE_URL}|g" gh-pages/index.html
          sed -i "s|TAG_PLACEHOLDER|${TAG}|g" gh-pages/index.html
          sed -i "s|DATE_PLACEHOLDER|${DATE}|g" gh-pages/index.html

      # ------------------------------------------------------------
      # üìò Push Wiki (auto branch detect)
      # ------------------------------------------------------------
      - name: üìò Push Wiki (auto branch detect)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          WIKI_URL="https://${ACTOR}:${GH_TOKEN}@github.com/${REPO}.wiki.git"

          rm -rf wiki.push && cp -r wiki wiki.push
          cd wiki.push
          git init
          git config user.name "$ACTOR"
          git config user.email "$ACTOR@users.noreply.github.com"
          git add .
          git commit -m "üìò Auto-update Wiki (v9.9.10 Full Stable)"
          git remote add origin "$WIKI_URL"
          git fetch origin || true
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | awk '{print $NF}' || echo "master")
          git push origin HEAD:$DEFAULT_BRANCH --force
          echo "‚úÖ Wiki pushed successfully to branch: ${DEFAULT_BRANCH}"
          echo "üîó https://github.com/${REPO}/wiki/Downloads"

      # ------------------------------------------------------------
      # üöÄ Publish GitHub Pages
      # ------------------------------------------------------------
      - name: üöÄ Publish gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
