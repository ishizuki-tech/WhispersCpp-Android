# ============================================================
# âœ… WhispersCpp-Android â€” CI Publish (v9.7.9a ManualSafe Final)
# ------------------------------------------------------------
# â€¢ Auto-triggered after ci-build.yml success (workflow_run)
# â€¢ Manual-safe (branch/artifact override)
# â€¢ Auto Wiki & Pages generation (Glass UI)
# â€¢ Improved API stability + orphan-safe Wiki push
# ============================================================

name: Android CI Publish (Meta + Pages + Wiki)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to publish (default: main)"
        default: "main"
      artifact_name:
        description: "Artifact name uploaded by build workflow"
        default: "release-artifacts"
  workflow_run:
    workflows: ["Android CI Build (Detect + Review + Build + Release)"]
    types: [completed]

permissions:
  contents: write
  pages: write

defaults:
  run:
    shell: bash

env:
  EXPECTED_WORKFLOW_NAME: "Android CI Build (Detect + Review + Build + Release)"
  DEFAULT_ARTIFACT_NAME: "release-artifacts"

jobs:
  meta_publish:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')

    steps:
      # ------------------------------------------------------------
      # ðŸ§© Checkout
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || 'main' }}

      # ------------------------------------------------------------
      # ðŸ› ï¸ Dependencies
      # ------------------------------------------------------------
      - name: ðŸ› ï¸ Install dependencies (jq/unzip/curl)
        run: |
          set -euxo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y jq unzip curl

      # ------------------------------------------------------------
      # ðŸ”Ž Resolve build run ID (manual-safe + fallback)
      # ------------------------------------------------------------
      - name: ðŸ”Ž Resolve build run ID
        id: resolve_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          REPO="${{ github.repository }}"
          TARGET_BRANCH="${{ inputs.branch || 'main' }}"
          WF_EXPECTED="${{ env.EXPECTED_WORKFLOW_NAME }}"

          echo "ðŸ” Event: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            RUN_ID="${{ github.event.workflow_run.id }}"
            echo "âœ… Linked mode: using build run $RUN_ID"
            echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ðŸ§­ Manual mode: searching latest successful build..."
          RUN_ID=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${REPO}/actions/runs?status=success&branch=${TARGET_BRANCH}&per_page=20" \
            | jq -r --arg name "${WF_EXPECTED}" '.workflow_runs[] | select(.name==$name) | .id' | head -n1)

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "::warning::No successful build found, trying last run (any status)..."
            RUN_ID=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${REPO}/actions/runs?branch=${TARGET_BRANCH}&per_page=10" \
              | jq -r --arg name "${WF_EXPECTED}" '.workflow_runs[] | select(.name==$name) | .id' | head -n1)
          fi

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "::error::No valid build run found on branch ${TARGET_BRANCH}"
            echo "run_id=" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "ðŸ“¦ Using build run ID: $RUN_ID"
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # ðŸ§  Extract tag from meta/models.json
      # ------------------------------------------------------------
      - name: ðŸ§  Extract tag from meta/models.json
        id: tag_from_meta
        if: ${{ steps.resolve_run.outputs.run_id != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          mkdir -p _meta
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve_run.outputs.run_id }}"
          echo "ðŸ” Fetching meta artifact list for run $RUN_ID..."
          curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
               -H "X-GitHub-Api-Version: 2022-11-28" \
               "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" > _meta/list.json

          jq -r '.artifacts[].name' _meta/list.json || echo "(no artifacts)"
          URL=$(jq -r '.artifacts[] | select(.name=="meta") | .archive_download_url' _meta/list.json | head -n1)
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "::notice::No meta artifact found."
            echo "has_meta=false" >> "$GITHUB_OUTPUT"
            echo "version_tag=unreleased" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "â¬‡ï¸ Downloading meta artifact..."
          curl -sL -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o _meta/meta.zip
          unzip -o _meta/meta.zip -d _meta >/dev/null || true
          TAG=$(jq -r '.version_tag // empty' _meta/models.json || echo "")
          if [ -n "$TAG" ]; then
            echo "ðŸª¶ Found tag: $TAG"
          else
            TAG="unreleased"
            echo "::notice::version_tag missing, fallback to '$TAG'"
          fi
          echo "has_meta=true" >> "$GITHUB_OUTPUT"
          echo "version_tag=$TAG" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # ðŸ·ï¸ Decide tag (meta > release > git)
      # ------------------------------------------------------------
      - name: ðŸ·ï¸ Decide tag
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          REPO="${{ github.repository }}"
          TAG_META="${{ steps.tag_from_meta.outputs.version_tag }}"
          if [ -n "$TAG_META" ]; then
            TAG="$TAG_META"; SRC="meta"
          else
            TAG=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${REPO}/releases/latest" | jq -r '.tag_name // empty')
            [ -n "$TAG" ] && SRC="release" || TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unreleased")
          fi
          echo "ðŸ§© Tag resolved: $TAG (source=$SRC)"
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # ðŸ“¦ Retrieve build artifacts
      # ------------------------------------------------------------
      - name: ðŸ“¦ Retrieve build artifacts
        id: fetch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          mkdir -p artifacts
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve_run.outputs.run_id }}"
          NAME_PRI="${{ inputs.artifact_name || env.DEFAULT_ARTIFACT_NAME }}"
          echo "ðŸ”Ž Searching artifacts for run $RUN_ID..."
          curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
               -H "X-GitHub-Api-Version: 2022-11-28" \
               "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" > artifacts_list.json

          jq -r '.artifacts[].name' artifacts_list.json || true
          URL=$(jq -r --arg n "$NAME_PRI" '.artifacts[] | select(.name==$n) | .archive_download_url' artifacts_list.json | head -n1)
          [ -z "$URL" ] && URL=$(jq -r '.artifacts[0].archive_download_url' artifacts_list.json)
          [ -z "$URL" ] && { echo "::warning::No artifact URL found"; exit 0; }
          curl -sL -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o artifacts.zip
          unzip -o artifacts.zip -d artifacts >/dev/null || true
          echo "ðŸ“‚ Artifact files:"; ls -lh artifacts || true

      # ------------------------------------------------------------
      # ðŸŒˆ Generate Wiki + Pages
      # ------------------------------------------------------------
      - name: ðŸŒˆ Generate Wiki + Pages (Glass UI)
        run: |
          set -euxo pipefail
          TAG=${{ steps.tag.outputs.tag_name }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages

          echo "# ðŸ“¦ WhispersCpp-Android (${TAG})" > wiki/Downloads.md
          echo "Updated: ${DATE}" >> wiki/Downloads.md
          echo >> wiki/Downloads.md
          echo "## ðŸ§© Artifacts" >> wiki/Downloads.md
          if compgen -G "artifacts/*.apk" >/dev/null; then
            for f in artifacts/*.apk; do
              N=$(basename "$f")
              echo "- [$N](https://github.com/${REPO}/releases/download/${TAG}/${N})" >> wiki/Downloads.md
            done
          else
            echo "_No artifacts found._" >> wiki/Downloads.md
          fi

          rm -rf gh-pages/.git || true
          cat > gh-pages/index.html <<HTML
          <!doctype html><html><head><meta charset="utf-8"/>
          <title>ðŸ“¦ WhispersCpp Downloads</title>
          <style>body{font-family:system-ui;background:#111;color:#ddd;text-align:center;padding:40px}
          a{color:#7bdcff;text-decoration:none}</style></head><body>
          <h1>ðŸ“¦ WhispersCpp-Android</h1><p>Tag: ${TAG}</p><ul>
          HTML
          for f in artifacts/*.apk 2>/dev/null; do
            N=$(basename "$f")
            echo "<li><a href='https://github.com/${REPO}/releases/download/${TAG}/${N}'>$N</a></li>" >> gh-pages/index.html
          done
          echo "</ul><footer>Generated ${DATE}</footer></body></html>" >> gh-pages/index.html

      # ------------------------------------------------------------
      # ðŸ“˜ Push Wiki (safe re-init)
      # ------------------------------------------------------------
      - name: ðŸ“˜ Push Wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          HAS_WIKI=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${REPO}" | jq -r '.has_wiki')
          [ "$HAS_WIKI" != "true" ] && { echo "::warning::Wiki disabled, skipping."; exit 0; }

          WIKI_URL="https://${ACTOR}:${GH_TOKEN}@github.com/${REPO}.wiki.git"
          rm -rf wiki.push && cp -r wiki wiki.push
          cd wiki.push
          git init
          git config user.name "$ACTOR"
          git config user.email "$ACTOR@users.noreply.github.com"
          git add .
          git commit -m "ðŸ“˜ Auto-update Wiki (${TAG})"
          git push --force "$WIKI_URL" master

      # ------------------------------------------------------------
      # ðŸš€ Publish gh-pages
      # ------------------------------------------------------------
      - name: ðŸš€ Publish gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
