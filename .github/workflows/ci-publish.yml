# ============================================================
# âœ… WhispersCpp-Android â€” CI Publish (v9.9.12 Tech Insight Edition)
# ------------------------------------------------------------
# â€¢ Adds detailed Technical Metadata (System, Build, Model, Artifacts)
# â€¢ Auto extracts data from meta/models.json
# â€¢ Fallback: latest release APKs if no artifacts
# â€¢ SafeHTML + QR + Wiki branch auto-detect (main/master)
# ============================================================

name: Android CI Publish (Meta + Pages + Wiki + TechInsight)

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Android CI Build (Detect + Review + Build + Release)"]
    types: [completed]

permissions:
  contents: write
  pages: write

defaults:
  run:
    shell: bash

env:
  EXPECTED_WORKFLOW_NAME: "Android CI Build (Detect + Review + Build + Release)"

jobs:
  publish:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')

    steps:
      # ------------------------------------------------------------
      # ðŸ§© Checkout + dependencies
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch || github.ref_name }}

      - name: ðŸ› ï¸ Install dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y jq unzip curl wget lsb-release

      # ------------------------------------------------------------
      # ðŸ”Ž Resolve workflow info
      # ------------------------------------------------------------
      - name: ðŸ”Ž Resolve workflow run
        id: resolve
        run: |
          set -euxo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
            echo "branch=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          else
            echo "ðŸ§­ Manual dispatch â€” no linked run_id."
          fi

      # ------------------------------------------------------------
      # ðŸ§  Detect tag + meta/models.json + system info
      # ------------------------------------------------------------
      - name: ðŸ§  Detect version tag & gather metadata
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve.outputs.run_id || '' }}"
          TAG="manual-run"

          mkdir -p _meta
          if [ -n "$RUN_ID" ]; then
            curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" > _meta/list.json
            META_URL=$(jq -r '.artifacts[] | select(.name=="meta") | .archive_download_url' _meta/list.json | head -n1)
            if [ -n "$META_URL" ] && [ "$META_URL" != "null" ]; then
              curl -sL -H "Authorization: Bearer ${GH_TOKEN}" "$META_URL" -o _meta/meta.zip
              unzip -o _meta/meta.zip -d _meta >/dev/null || true
              TAG=$(jq -r '.version_tag // empty' _meta/models.json || true)
            fi
          fi

          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            TAG=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/releases/latest" \
              | jq -r '.tag_name // "unreleased"')
          fi

          # Capture environment info
          {
            echo "os=$(lsb_release -sd || uname -a)"
            echo "kernel=$(uname -r)"
            echo "cpu=$(nproc)"
            echo "java=$(java -version 2>&1 | head -n1 || true)"
            echo "gradle=$(gradle -v | grep Gradle || true)"
          } > _meta/system.txt

          echo "version_tag=$TAG" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # ðŸ“¦ Retrieve artifacts or release APKs
      # ------------------------------------------------------------
      - name: ðŸ“¦ Retrieve artifacts / release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          mkdir -p artifacts
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve.outputs.run_id || '' }}"

          if [ -n "$RUN_ID" ]; then
            curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" > artifacts_list.json
            URL=$(jq -r '.artifacts[0].archive_download_url' artifacts_list.json)
            if [ -n "$URL" ] && [ "$URL" != "null" ]; then
              curl -sL -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o artifacts.zip
              unzip -o artifacts.zip -d artifacts >/dev/null || true
            fi
          fi

          if ! compgen -G "artifacts/*.apk" >/dev/null; then
            RELEASE_JSON=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/releases/latest")
            echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name|endswith(".apk")) | .browser_download_url' > release_apks.txt
            if [ -s release_apks.txt ]; then
              while read -r URL; do
                wget -q --content-disposition "$URL" -P artifacts || true
              done < release_apks.txt
            fi
          fi

      # ------------------------------------------------------------
      # ðŸŒˆ Generate Wiki + Pages with Tech info
      # ------------------------------------------------------------
      - name: ðŸŒˆ Generate Wiki + Pages (Tech Insight)
        run: |
          set -euxo pipefail
          TAG=${{ steps.tag.outputs.version_tag }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages

          {
            echo "# ðŸ“¦ WhispersCpp-Android (${TAG})"
            echo "Updated: ${DATE}"
            echo
            if [ -f _meta/models.json ]; then
              echo "## ðŸŽ§ Whisper Model Specifications"
              echo "| Model | Params | Size | Speed | Notes | Source |"
              echo "|:--|:--|:--|:--|:--|:--|"
              jq -r '.models[] | "| \(.name) | \(.params) | \(.size) | \(.speed) | \(.notes) | \(.source) |"' _meta/models.json || true
              echo
            fi
            echo "## ðŸ§© Build Artifacts"
            if compgen -G "artifacts/*.apk" >/dev/null; then
              echo "| File | Size | SHA256 |"
              echo "|:--|:--|:--|"
              for f in artifacts/*.apk; do
                N=$(basename "$f")
                S=$(du -h "$f" | cut -f1)
                H=$(sha256sum "$f" | cut -d' ' -f1)
                echo "| [$N](https://github.com/${REPO}/releases/download/${TAG}/${N}) | $S | \`$H\` |"
              done
              echo
            else
              echo "_No APK artifacts found._"
              echo
            fi
            echo "## âš™ï¸ System & Build Info"
            if [ -f _meta/system.txt ]; then
              echo '```'
              cat _meta/system.txt
              echo '```'
            else
              echo "_No system metadata captured._"
            fi
            echo
            echo "## ðŸ”— GitHub Pages"
            echo "${BASE_URL}"
          } > wiki/Downloads.md

      # ------------------------------------------------------------
      # ðŸ“˜ Push Wiki + ðŸš€ Publish Pages
      # ------------------------------------------------------------
      - name: ðŸ“˜ Push Wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          WIKI_URL="https://${ACTOR}:${GH_TOKEN}@github.com/${REPO}.wiki.git"
          rm -rf wiki.push && cp -r wiki wiki.push
          cd wiki.push
          git init
          git config user.name "$ACTOR"
          git config user.email "$ACTOR@users.noreply.github.com"
          git add .
          git commit -m "ðŸ“˜ Auto-update Wiki (v9.9.12 Tech Insight)"
          git remote add origin "$WIKI_URL"
          git fetch origin || true
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | awk '{print $NF}' || echo "master")
          git push origin HEAD:$DEFAULT_BRANCH --force

      - name: ðŸš€ Publish gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
