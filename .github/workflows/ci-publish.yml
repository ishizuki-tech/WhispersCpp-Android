# ============================================================
# ‚úÖ WhispersCpp-Android ‚Äî CI Publish (v9.7.6 NoTagSync ‚Ä¢ Final)
# ------------------------------------------------------------
# ‚Ä¢ Auto-triggered after ci-build.yml success (workflow_run)
# ‚Ä¢ Also runnable manually (workflow_dispatch)
# ‚Ä¢ No AutoTag: Êó¢Â≠ò„Çø„Ç∞/„É™„É™„Éº„Çπ„ÇíÂÜçÂà©Áî®Ôºà‰ΩúÊàê„Åó„Å™„ÅÑÔºâ
# ‚Ä¢ TagËß£Ê±∫ÂÑ™ÂÖàÂ∫¶: build meta > latest release > last git tag > 'unreleased'
# ‚Ä¢ Âº∑Âåñ: artifactÂèñÂæó/„É≠„Ç∞, releaseÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ, ÊúÄÊñ∞ReleaseË≥áÁî£„Åß„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
# ‚Ä¢ Pages„ÅØ gh-pages „Éñ„É©„É≥„ÉÅÁõ¥‰∏ã index.html „ÇíÂ∏∏„Å´ÁîüÊàê
# ============================================================

name: Android CI Publish (Meta + Pages + Wiki)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to publish (default: main)"
        default: "main"
      artifact_name:
        description: "Artifact name uploaded by build workflow"
        default: "release-artifacts"
  workflow_run:
    workflows: ["Android CI Build (Review + Build)"]
    types: [completed]

permissions:
  contents: write

defaults:
  run:
    shell: bash

env:
  EXPECTED_WORKFLOW_NAME: "Android CI Build (Review + Build)"
  DEFAULT_ARTIFACT_NAME: "release-artifacts"

jobs:
  meta_publish:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || 'main' }}

      - name: üõ†Ô∏è Install dependencies (jq/unzip)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      # ------------------------------------------------------------
      # üîé Resolve build run ID (linked or manual fallback)
      # ------------------------------------------------------------
      - name: üîé Resolve build run ID
        id: resolve_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${{ github.repository }}"
          TARGET_BRANCH="${{ inputs.branch || 'main' }}"
          WF_EXPECTED="${{ env.EXPECTED_WORKFLOW_NAME }}"

          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            RUN_ID="${{ github.event.workflow_run.id }}"
            echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
            echo "mode=linked"    >> "$GITHUB_OUTPUT"
            echo "üîó Linked mode: Using build run $RUN_ID"
            exit 0
          fi

          echo "üß≠ Manual mode: search latest successful build on branch: $TARGET_BRANCH"
          RUN_ID=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/runs?status=success&branch=${TARGET_BRANCH}&per_page=50" \
            | jq -r --arg name "${WF_EXPECTED}" '.workflow_runs[] | select(.name==$name) | .id' | head -n1)

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "::warning::No successful build run found on ${TARGET_BRANCH}."
            echo "run_id=" >> "$GITHUB_OUTPUT"
          else
            echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
            echo "üì¶ Using run ID: $RUN_ID"
          fi

      # ------------------------------------------------------------
      # üß† Try get TAG from build meta/models.json (if meta artifact exists)
      # ------------------------------------------------------------
      - name: ‚¨áÔ∏è Try read tag from meta artifact (models.json)
        id: tag_from_meta
        if: ${{ steps.resolve_run.outputs.run_id != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve_run.outputs.run_id }}"
          mkdir -p _meta
          echo "üîé Listing artifacts for run $RUN_ID ..."
          curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" \
            | tee _meta/list.json >/dev/null

          URL=$(jq -r '.artifacts[] | select(.name=="meta") | .archive_download_url' _meta/list.json | head -n1)
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "has_meta=false" >> "$GITHUB_OUTPUT"
            echo "version_tag="   >> "$GITHUB_OUTPUT"
            echo "::notice::No 'meta' artifact in build run."
            exit 0
          fi

          echo "‚¨áÔ∏è Downloading meta artifact ..."
          curl -L -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o _meta/meta.zip
          unzip -o _meta/meta.zip -d _meta >/dev/null || true

          if [ -f _meta/models.json ]; then
            TAG=$(jq -r '.version_tag // empty' _meta/models.json)
            if [ -n "$TAG" ]; then
              echo "has_meta=true"     >> "$GITHUB_OUTPUT"
              echo "version_tag=$TAG"  >> "$GITHUB_OUTPUT"
              echo "ü™∂ Found version_tag in meta: $TAG"
              exit 0
            fi
          fi

          echo "has_meta=false" >> "$GITHUB_OUTPUT"
          echo "version_tag="   >> "$GITHUB_OUTPUT"
          echo "::notice::meta/models.json not found or version_tag empty."

      # ------------------------------------------------------------
      # üè∑Ô∏è Decide tag (No AutoTag) ‚Äî meta > latest release > last git tag > 'unreleased'
      # ------------------------------------------------------------
      - name: üè∑Ô∏è Decide tag (No AutoTag)
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${{ github.repository }}"
          TAG_FROM_META="${{ steps.tag_from_meta.outputs.version_tag }}"

          if [ -n "$TAG_FROM_META" ]; then
            TAG="$TAG_FROM_META"
            SRC="meta"
          else
            TAG=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/releases/latest" | jq -r '.tag_name')
            if [ -n "$TAG" ] && [ "$TAG" != "null" ]; then
              SRC="latest_release"
            else
              TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unreleased")
              SRC="git_or_unreleased"
            fi
          fi

          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
          echo "tag_src=$SRC"  >> "$GITHUB_OUTPUT"
          echo "ü™∂ Using tag: $TAG (src=$SRC)"

      # ------------------------------------------------------------
      # ‚¨áÔ∏è Retrieve build artifacts (release-artifacts or first)
      # ------------------------------------------------------------
      - name: ‚¨áÔ∏è Retrieve build artifacts
        id: fetch
        if: ${{ steps.resolve_run.outputs.run_id != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          mkdir -p artifacts
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve_run.outputs.run_id }}"
          NAME_PRI="${{ inputs.artifact_name || env.DEFAULT_ARTIFACT_NAME }}"

          echo "üîé Listing artifacts in run ${RUN_ID}‚Ä¶"
          curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" \
            | tee artifacts_list.json >/dev/null

          echo "üìú Artifact names in run:"
          jq -r '.artifacts[].name' artifacts_list.json || true

          URL=$(jq -r --arg n "$NAME_PRI" '.artifacts[] | select(.name==$n) | .archive_download_url' artifacts_list.json | head -n1)
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "::warning::Artifact '$NAME_PRI' not found. Use first artifact."
            URL=$(jq -r '.artifacts[0].archive_download_url' artifacts_list.json)
          fi
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "::warning::No downloadable artifacts for run $RUN_ID"
            echo "has_artifacts=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "‚¨áÔ∏è Downloading artifact zip‚Ä¶"
          curl -L -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o artifacts.zip
          unzip -o artifacts.zip -d artifacts >/dev/null || true
          rm -f artifacts.zip

          echo "üìÇ Downloaded files:"
          (ls -al artifacts || true)

          if compgen -G "artifacts/*.apk" >/dev/null || compgen -G "artifacts/*.aab" >/dev/null; then
            echo "has_artifacts=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_artifacts=false" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # üß™ Check if Release exists for decided tag (NoTagSync)
      # ------------------------------------------------------------
      - name: üîê Check release existence for decided tag
        id: rel_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${{ github.repository }}"
          TAG="${{ steps.tag.outputs.tag_name }}"

          REL_ID=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/releases/tags/${TAG}" | jq -r '.id')

          if [ -n "$REL_ID" ] && [ "$REL_ID" != "null" ]; then
            echo "release_exists=true"  >> "$GITHUB_OUTPUT"
            echo "release_id=$REL_ID"  >> "$GITHUB_OUTPUT"
            echo "‚úÖ Release exists for tag: $TAG (id=$REL_ID)"
          else
            echo "release_exists=false" >> "$GITHUB_OUTPUT"
            echo "release_id="          >> "$GITHUB_OUTPUT"
            echo "::warning::No release found for tag '$TAG'. (NoTagSync: we will NOT create one.)"
          fi

      # ------------------------------------------------------------
      # üöÄ Upload artifacts to existing Release (only if both exist)
      # ------------------------------------------------------------
      - name: üöÄ Upload artifacts to existing Release
        if: ${{ steps.fetch.outputs.has_artifacts == 'true' && steps.rel_check.outputs.release_exists == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: "WhispersCpp Release ${{ steps.tag.outputs.tag_name }}"
          files: |
            artifacts/*.apk
            artifacts/*.aab
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------
      # ‚ôªÔ∏è Fallback listing from latest release assets (if no artifacts or no release)
      # ------------------------------------------------------------
      - name: ‚ôªÔ∏è Prepare latest release assets (fallback)
        id: fallback_assets
        if: ${{ steps.fetch.outputs.has_artifacts != 'true' || steps.rel_check.outputs.release_exists != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${{ github.repository }}"
          mkdir -p artifacts
          echo "üß© Using latest release assets for listing fallback‚Ä¶"
          curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/releases/latest" > release.json || true
          if [ -s release.json ]; then
            jq -r '.assets[] | select(.name|test("\\.(apk|aab)$")) | [.name, (.size|tostring), .browser_download_url] | @tsv' release.json \
              > artifacts/_release_assets.tsv || true
            echo "has_fallback=true" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::No latest release found (or no assets)."
            echo "has_fallback=false" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # üåà Generate Wiki + Pages (Glass UI)
      # ------------------------------------------------------------
      - name: üåà Generate Wiki + Pages (Glass UI)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG=${{ steps.tag.outputs.tag_name }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages

          # ---------- Wiki ----------
          {
            echo "# üì¶ WhispersCpp-Android (${TAG})"
            echo "Updated: ${DATE}"
            echo
            echo "## üß© Build Artifacts"
            if compgen -G "artifacts/*.apk" >/dev/null || compgen -G "artifacts/*.aab" >/dev/null; then
              for f in artifacts/*.apk artifacts/*.aab; do
                N=$(basename "$f")
                echo "- [$N](https://github.com/${REPO}/releases/download/${TAG}/${N})"
              done
            elif [ -f artifacts/_release_assets.tsv ]; then
              echo "_Using latest release assets for listing_"
              while IFS=$'\t' read -r N S U; do
                echo "- [$N]($U) ‚Äî ${S} bytes"
              done < artifacts/_release_assets.tsv
            else
              echo "_No artifacts available for this tag._"
            fi
            echo
            echo "## üîó Downloads Page"
            echo "<div align=\"center\">"
            echo "<img src=\"https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${BASE_URL}\" width=\"180\" height=\"180\"><br>"
            echo "üîó <a href=\"${BASE_URL}\">Open Glass UI Downloads Page</a>"
            echo "</div>"
          } > wiki/Downloads.md

          # ---------- Pages (root index.html on gh-pages) ----------
          cat > gh-pages/index.html <<HTML
          <!doctype html>
          <html lang="en"><head><meta charset="utf-8"/>
          <title>üì¶ WhispersCpp-Android Downloads</title>
          <meta name="viewport" content="width=device-width,initial-scale=1"/>
          <style>
            body{font-family:system-ui;background:#111;color:#ddd;text-align:center;padding:40px;margin:0}
            .box{background:#1b1b1b;border:1px solid #2a2a2a;border-radius:14px;max-width:900px;margin:24px auto;padding:24px}
            a{color:#7bdcff;text-decoration:none}a:hover{text-decoration:underline}
            ul{list-style:none;padding:0} li{margin:8px 0}
            footer{margin-top:20px;color:#aaa}
          </style></head><body>
          <div class="box">
            <h1>üì¶ WhispersCpp-Android</h1>
            <p>Tag: ${TAG} ‚Äî Updated: ${DATE}</p>
            <ul>
          HTML

          if compgen -G "artifacts/*.apk" >/dev/null || compgen -G "artifacts/*.aab" >/dev/null; then
            for f in artifacts/*.apk artifacts/*.aab; do
              N=$(basename "$f")
              echo "<li><a href='https://github.com/${REPO}/releases/download/${TAG}/${N}'>$N</a></li>" >> gh-pages/index.html
            done
          elif [ -f artifacts/_release_assets.tsv ]; then
            while IFS=$'\t' read -r N S U; do
              echo "<li><a href='${U}'>$N</a> ‚Äî ${S} bytes</li>" >> gh-pages/index.html
            done < artifacts/_release_assets.tsv
          else
            echo "<li><em>No artifacts available for this tag.</em></li>" >> gh-pages/index.html
          fi

          cat >> gh-pages/index.html <<'HTML'
            </ul>
            <footer>Generated automatically by CI/CD v9.7.6 NoTagSync</footer>
          </div></body></html>
          HTML

      # ------------------------------------------------------------
      # üìò Push Wiki (guarded)
      # ------------------------------------------------------------
      - name: üìò Push Wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          HAS_WIKI=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" "https://api.github.com/repos/${REPO}" | jq -r '.has_wiki')
          if [ "$HAS_WIKI" != "true" ]; then
            echo "::warning::Wiki is disabled. Skipping."
            exit 0
          fi
          WIKI_URL="https://${ACTOR}:${GH_TOKEN}@github.com/${REPO}.wiki.git"
          rm -rf wiki.push && cp -r wiki wiki.push
          cd wiki.push
          git init
          git config user.name "${ACTOR}"
          git config user.email "${ACTOR}@users.noreply.github.com"
          git add Downloads.md
          git commit -m "Auto-update Wiki (v9.7.6 NoTagSync)"
          git branch -M master
          git remote add origin "$WIKI_URL"
          git push origin master --force

      # ------------------------------------------------------------
      # üåê Publish GitHub Pages (root index.html)
      # ------------------------------------------------------------
      - name: üöÄ Publish gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
