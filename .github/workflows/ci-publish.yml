# ============================================================
# âœ… WhispersCpp-Android â€” CI Publish (v9.9.5 SafeHTML + AutoBranch + Glass UI Final)
# ------------------------------------------------------------
# â€¢ Triggered after Build workflow success or manual dispatch
# â€¢ Auto branch detection (head_branch)
# â€¢ Safe HTML generation (indented heredoc)
# â€¢ Wiki + Pages auto-sync (Glass UI)
# ============================================================

name: Android CI Publish (Meta + Pages + Wiki)

on:
  workflow_dispatch:
    inputs:
      artifact_name:
        description: "Artifact name uploaded by build workflow"
        default: "release-artifacts"
  workflow_run:
    workflows: ["Android CI Build (Detect + Review + Build + Release)"]
    types: [completed]

permissions:
  contents: write
  pages: write

defaults:
  run:
    shell: bash

env:
  EXPECTED_WORKFLOW_NAME: "Android CI Build (Detect + Review + Build + Release)"
  DEFAULT_ARTIFACT_NAME: "release-artifacts"

jobs:
  meta_publish:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')

    steps:
      # ------------------------------------------------------------
      # ðŸ§© Checkout (auto branch)
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch || github.ref_name }}

      # ------------------------------------------------------------
      # ðŸ› ï¸ Dependencies
      # ------------------------------------------------------------
      - name: ðŸ› ï¸ Install dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y jq unzip curl

      # ------------------------------------------------------------
      # ðŸ”Ž Resolve build run ID
      # ------------------------------------------------------------
      - name: ðŸ”Ž Resolve build run ID
        id: resolve_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            RUN_ID="${{ github.event.workflow_run.id }}"
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
            echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
            echo "âœ… Using workflow_run from branch ${BRANCH}"
            exit 0
          fi

          echo "ðŸ§­ Manual trigger â€” finding latest successful build..."
          REPO="${{ github.repository }}"
          WF_NAME="${{ env.EXPECTED_WORKFLOW_NAME }}"
          RUN_ID=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/runs?status=success&per_page=10" \
            | jq -r --arg name "$WF_NAME" '.workflow_runs[] | select(.name==$name) | .id' | head -n1)
          [ -z "$RUN_ID" ] && { echo "::error::No successful build run found."; exit 1; }
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # ðŸ§  Extract tag from meta/models.json
      # ------------------------------------------------------------
      - name: ðŸ§  Extract tag from meta/models.json
        id: tag_from_meta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          mkdir -p _meta
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve_run.outputs.run_id }}"
          echo "Fetching meta artifact from run $RUN_ID ..."
          curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" > _meta/list.json

          URL=$(jq -r '.artifacts[] | select(.name=="meta") | .archive_download_url' _meta/list.json | head -n1)
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "version_tag=unreleased" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          curl -sL -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o _meta/meta.zip
          unzip -o _meta/meta.zip -d _meta >/dev/null || true
          TAG=$(jq -r '.version_tag // "unreleased"' _meta/models.json)
          echo "ðŸª¶ Detected tag: $TAG"
          echo "version_tag=$TAG" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # ðŸ“¦ Retrieve artifacts
      # ------------------------------------------------------------
      - name: ðŸ“¦ Retrieve artifacts
        id: fetch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          mkdir -p artifacts
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.resolve_run.outputs.run_id }}"
          NAME="${{ inputs.artifact_name || env.DEFAULT_ARTIFACT_NAME }}"

          echo "ðŸ” Fetching artifact list for run $RUN_ID ..."
          curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" > artifacts_list.json

          URL=$(jq -r --arg n "$NAME" '.artifacts[] | select(.name==$n) | .archive_download_url' artifacts_list.json | head -n1)
          [ -z "$URL" ] && URL=$(jq -r '.artifacts[0].archive_download_url' artifacts_list.json)
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "::warning::No artifact found â€” skipping page/wiki."
            exit 0
          fi

          curl -sL -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o artifacts.zip
          unzip -o artifacts.zip -d artifacts >/dev/null || true
          echo "âœ… Extracted artifacts:"; ls -lh artifacts || true

      # ------------------------------------------------------------
      # ðŸŒˆ Generate Wiki + Pages (Glass UI)
      # ------------------------------------------------------------
      - name: ðŸŒˆ Generate Wiki + Pages (Glass UI)
        run: |
          set -euxo pipefail
          TAG=${{ steps.tag_from_meta.outputs.version_tag }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages

          # ---------- Wiki ----------
          {
            echo "# ðŸ“¦ WhispersCpp-Android (${TAG})"
            echo "Updated: ${DATE}"
            echo
            echo "## ðŸ§© Artifacts"
            if compgen -G "artifacts/*.apk" >/dev/null; then
              for f in artifacts/*.apk; do
                N=$(basename "$f")
                echo "- [$N](https://github.com/${REPO}/releases/download/${TAG}/${N})"
              done
            else
              echo "_No artifacts found._"
            fi
          } > wiki/Downloads.md

          # ---------- Safe HTML ----------
          cat > gh-pages/index.html <<'HTML'
            <!doctype html>
            <html lang="en">
            <head>
              <meta charset="utf-8"/>
              <meta name="viewport" content="width=device-width,initial-scale=1"/>
              <title>ðŸ“¦ WhispersCpp-Android Downloads</title>
              <style>
                body{font-family:'Inter',system-ui;background:#0a0a0f;color:#eee;text-align:center;padding:40px;margin:0}
                .glass{background:rgba(255,255,255,0.08);border-radius:20px;box-shadow:0 4px 40px rgba(0,0,0,0.3);
                backdrop-filter:blur(12px);padding:30px;margin:40px auto;width:90%;max-width:900px;}
                table{width:100%;border-collapse:collapse;margin-top:20px;}
                th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);}
                a{color:#00eaff;text-decoration:none;}a:hover{text-decoration:underline;}
                footer{margin-top:30px;font-size:0.85em;color:#aaa;}
              </style>
            </head>
            <body>
              <div class="glass">
                <h1>ðŸ“¦ WhispersCpp-Android</h1>
                <p><img src="https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=BASE_URL_PLACEHOLDER" width="100" height="100" alt="QR"></p>
                <p>Tag: TAG_PLACEHOLDER â€¢ Updated: DATE_PLACEHOLDER</p>
                <table><tr><th>File</th><th>Size</th></tr>
          HTML

          if compgen -G "artifacts/*.apk" >/dev/null; then
            for f in artifacts/*.apk; do
              N=$(basename "$f")
              S=$(du -h "$f" | cut -f1)
              echo "<tr><td><a href='https://github.com/${REPO}/releases/download/${TAG}/${N}'>$N</a></td><td>$S</td></tr>" >> gh-pages/index.html
            done
          fi

          cat >> gh-pages/index.html <<'HTML'
                </table>
                <footer>Generated automatically by CI/CD v9.9.5 Glass UI</footer>
              </div>
            </body>
            </html>
          HTML

          sed -i "s|BASE_URL_PLACEHOLDER|${BASE_URL}|g" gh-pages/index.html
          sed -i "s|TAG_PLACEHOLDER|${TAG}|g" gh-pages/index.html
          sed -i "s|DATE_PLACEHOLDER|${DATE}|g" gh-pages/index.html

      # ------------------------------------------------------------
      # ðŸ“˜ Push Wiki
      # ------------------------------------------------------------
      - name: ðŸ“˜ Push Wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          TAG_VAL="${{ steps.tag_from_meta.outputs.version_tag }}"
          WIKI_URL="https://${ACTOR}:${GH_TOKEN}@github.com/${REPO}.wiki.git"

          rm -rf wiki.push && cp -r wiki wiki.push
          cd wiki.push
          git init
          git config user.name "$ACTOR"
          git config user.email "$ACTOR@users.noreply.github.com"
          git add .
          git commit -m "ðŸ“˜ Auto-update Wiki (${TAG_VAL})"
          git branch -M main
          git remote add origin "$WIKI_URL"
          git push origin main --force

      # ------------------------------------------------------------
      # ðŸš€ Publish gh-pages
      # ------------------------------------------------------------
      - name: ðŸš€ Publish gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
