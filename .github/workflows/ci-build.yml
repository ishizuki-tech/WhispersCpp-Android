# ============================================================
# âœ… WhispersCpp-Android â€” CI/CD Build (v9.9.6 AutoBranch + MetaSync + AutoRelease Stable)
# ------------------------------------------------------------
# â€¢ Detect â†’ Review â†’ Build â†’ Release
# â€¢ Whisper models auto-download (verified)
# â€¢ meta/models.json includes full Whisper model specs + REAL SIZE
# â€¢ No branch input: uses same branch as "Use workflow from"
# â€¢ Compatible with CI Publish v9.9.30+
# ============================================================

name: Android CI Build (Detect + Review + Build + Release)

on:
  workflow_dispatch:
    inputs:
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      create_release:
        description: "Publish GitHub Release after build"
        type: boolean
        default: true
      force_build:
        description: "Force build even if no diff detected"
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      force: ${{ steps.force.outputs.force }}
      last_tag: ${{ steps.tag.outputs.last_tag }}
      current_branch: ${{ steps.branch.outputs.current_branch }}

    steps:
      # ------------------------------------------------------------
      # Checkout & Branch detection (same as "Use workflow from")
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: branch
        run: |
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          echo "current_branch=${BRANCH_NAME}" >> "$GITHUB_OUTPUT"
          echo "ðŸŒ¿ Using branch: ${BRANCH_NAME}"

      - id: tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            LAST_TAG="v9.9.6-$(date '+%Y%m%d-%H%M')"
          fi
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "ðŸª¶ Last tag: ${LAST_TAG}"

      - id: check
        run: |
          set -e
          TARGETS="app/ nativelib/ gradle.properties gradle/libs.versions.toml gradle/wrapper/"
          if git rev-parse "${{ steps.tag.outputs.last_tag }}" >/dev/null 2>&1; then
            DIFF=$(git diff --name-only ${{ steps.tag.outputs.last_tag }} HEAD -- $TARGETS \
              | grep -E '\.(kt|java|cpp|cc|h|hpp|gradle|kts|toml|properties|xml|aidl|pro|bat|jar)$' || true)
          else
            DIFF="(initial-build)"
          fi
          echo "ðŸ” Diff detected files:"; echo "$DIFF"
          if [ "$DIFF" = "(initial-build)" ] || [ -n "$DIFF" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - id: force
        run: |
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "force=true" >> "$GITHUB_OUTPUT"
          else
            echo "force=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Review + Build + Release
    runs-on: ubuntu-latest
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' || needs.detect.outputs.force == 'true' }}

    steps:
      # ------------------------------------------------------------
      # Checkout current branch automatically
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ needs.detect.outputs.current_branch }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          cache: true

      # ------------------------------------------------------------
      # Gradle Cache
      # ------------------------------------------------------------
      - uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            app/.cxx
            .gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('gradle/libs.versions.toml','gradle.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      # ------------------------------------------------------------
      # Clean (DexSafe)
      # ------------------------------------------------------------
      - name: â™»ï¸ Clean Gradle transforms
        run: |
          echo "ðŸ§¹ Cleaning Gradle transform cache..."
          rm -rf ~/.gradle/caches/transforms-* ~/.gradle/caches/jars-* || true
          ./gradlew clean --no-daemon

      # ------------------------------------------------------------
      # Lint + Unit Tests (conditional)
      # ------------------------------------------------------------
      - name: ðŸ§ª Run Lint & Unit Tests
        if: ${{ inputs.enable_review == true }}
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint failed"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Tests failed"

      # ------------------------------------------------------------
      # Gradle Optimization
      # ------------------------------------------------------------
      - name: ðŸ§  Setup gradle.properties
        run: |
          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx3g -XX:+HeapDumpOnOutOfMemoryError
          android.useFullClasspathForDexingTransform=true
          org.gradle.parallel=true
          org.gradle.caching=true
          EOF

      # ------------------------------------------------------------
      # Whisper Model Auto Download
      # ------------------------------------------------------------
      - name: ðŸŽ§ Download Whisper models
        run: |
          set -euo pipefail
          mkdir -p app/src/main/assets/models
          cd app/src/main/assets/models
          echo "ðŸ“¦ Downloading Whisper models..."

          download() {
            name="$1"; shift
            urls=("$@")
            for u in "${urls[@]}"; do
              echo "â†’ Trying $u"
              if curl -fSL -A "curl/8.x (GitHub Actions)" --retry 3 --retry-delay 2 -o "$name.tmp" "$u"; then
                mv "$name.tmp" "$name"
                size=$(du -h "$name" | cut -f1)
                echo "âœ… $name ($size)"
                return 0
              fi
            done
            echo "::error::Failed to fetch $name"
            return 1
          }

          download ggml-tiny-q5_1.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny-q5_1.bin"
          download ggml-base-q5_1.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base-q5_1.bin"
          download ggml-small-q5_1.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small-q5_1.bin"
          download ggml-model-q4_0.bin \
            "https://huggingface.co/jboat/jacaranda-asr-whispercpp/resolve/main/ggml-model-q4_0.bin"

          echo "--- Downloaded files ---"; ls -lh

      # ------------------------------------------------------------
      # Build Release
      # ------------------------------------------------------------
      - name: ðŸ—ï¸ Build Release (DexFull)
        env:
          GRADLE_OPTS: "-Xmx3G -Dorg.gradle.daemon=false"
        run: |
          echo "ðŸ—ï¸ Building release..."
          ./gradlew :app:assembleRelease :app:bundleRelease --stacktrace --no-daemon --info

      # ------------------------------------------------------------
      # Collect outputs
      # ------------------------------------------------------------
      - id: collect
        run: |
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt
          if [ ! -s outputs/files.txt ]; then
            echo "::warning::No APK/AAB found"
          else
            echo "ðŸ“¦ Artifacts:"; cat outputs/files.txt
          fi

      # ------------------------------------------------------------
      # Upload artifacts for Publish workflow
      # ------------------------------------------------------------
      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            app/build/outputs/**/*.apk
            app/build/outputs/**/*.aab
          retention-days: 7

      # ------------------------------------------------------------
      # Generate meta/models.json (FULL + REAL SIZE)
      # ------------------------------------------------------------
      - name: ðŸ“„ Generate meta/models.json (Whisper Metadata + Size)
        run: |
          set -euo pipefail
          mkdir -p meta
          TAG=${{ needs.detect.outputs.last_tag }}
          DATE=$(date '+%Y-%m-%d %H:%M')

          size_or_null () {
            f="app/src/main/assets/models/$1"
            if [ -f "$f" ]; then du -h "$f" | cut -f1; else echo null; fi
          }

          TINY_SIZE=$(size_or_null ggml-tiny-q5_1.bin)
          BASE_SIZE=$(size_or_null ggml-base-q5_1.bin)
          SMALL_SIZE=$(size_or_null ggml-small-q5_1.bin)
          JACA_SIZE=$(size_or_null ggml-model-q4_0.bin)

          cat > meta/models.json <<JSON
          {
            "version_tag": "${TAG}",
            "generated": "${DATE}",
            "branch": "${{ needs.detect.outputs.current_branch }}",
            "heap": "3G",
            "cache_enabled": true,
            "models": [
              {
                "name": "ggml-tiny-q5_1.bin",
                "params": "39M",
                "size": ${TINY_SIZE:+\"$TINY_SIZE\"},
                "speed": "~32Ã— RT",
                "notes": "Multilingual (EN/JP/SW)",
                "source": "https://huggingface.co/ggerganov/whisper.cpp"
              },
              {
                "name": "ggml-base-q5_1.bin",
                "params": "74M",
                "size": ${BASE_SIZE:+\"$BASE_SIZE\"},
                "speed": "~16Ã— RT",
                "notes": "Balanced multilingual model",
                "source": "https://huggingface.co/ggerganov/whisper.cpp"
              },
              {
                "name": "ggml-small-q5_1.bin",
                "params": "244M",
                "size": ${SMALL_SIZE:+\"$SMALL_SIZE\"},
                "speed": "~8Ã— RT",
                "notes": "High accuracy (medium speed)",
                "source": "https://huggingface.co/ggerganov/whisper.cpp"
              },
              {
                "name": "ggml-model-q4_0.bin",
                "params": "1.5B",
                "size": ${JACA_SIZE:+\"$JACA_SIZE\"},
                "speed": "~2Ã— RT",
                "notes": "Jacaranda Swahili fine-tuned model",
                "source": "https://huggingface.co/jboat/jacaranda-asr-whispercpp"
              }
            ]
          }
          JSON

          echo "âœ… meta/models.json generated:"
          cat meta/models.json

      - uses: actions/upload-artifact@v4
        with:
          name: meta
          path: meta/
          retention-days: 7

      # ------------------------------------------------------------
      # GitHub Release
      # ------------------------------------------------------------
      - id: version
        run: |
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
          TAG="v${VERSION}-$(date '+%Y%m%d-%H%M')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "ðŸª¶ Release tag: $TAG"

      - uses: softprops/action-gh-release@v2
        if: ${{ inputs.create_release == true }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "WhispersCpp Release ${{ steps.version.outputs.tag }}"
          files: |
            app/build/outputs/**/*.apk
            app/build/outputs/**/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Build Finished
        run: |
          echo "âœ… WhispersCpp-Android build completed successfully."
          echo "Branch: ${{ needs.detect.outputs.current_branch }}"
          echo "Artifacts + meta uploaded (release-artifacts, meta)."
