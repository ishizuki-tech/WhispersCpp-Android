# ============================================================
# âœ… WhispersCpp-Android â€” CI Build (v9.7.8 MetaSync-DexFull + CacheSafe Final)
# ------------------------------------------------------------
# â€¢ AGP 8.13.0 + Gradle 8.10 å¯¾å¿œ
# â€¢ Diff æ¤œå‡º + Review + Release Build
# â€¢ Gradle + NDK ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–
# â€¢ Dex safe build (Heap limit + éƒ¨åˆ†Clean)
# â€¢ Safe multiline outputs (EOF error é˜²æ­¢)
# ============================================================

name: Android CI Build (Review + Build)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build"
        required: false
        default: "main"
      enable_review:
        description: "Run Lint & Unit Tests"
        type: boolean
        default: true
      force_build:
        description: "Force build even if no diff detected"
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      force: ${{ steps.force.outputs.force }}
      last_tag: ${{ steps.tag.outputs.last_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - id: tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            LAST_TAG="v9.7.8-$(date '+%Y%m%d-%H%M')"
          fi
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "ðŸª¶ Last tag: ${LAST_TAG}"

      - id: check
        run: |
          set -e
          TARGETS="app/ nativelib/ gradle.properties gradle/libs.versions.toml gradle/wrapper/gradle-wrapper.properties gradle/wrapper/gradle-wrapper.jar gradlew gradlew.bat"
          if [ -n "${{ steps.tag.outputs.last_tag }}" ]; then
            DIFF=$(git diff --name-only ${{ steps.tag.outputs.last_tag }} HEAD -- $TARGETS | grep -E '\.(kt|java|cpp|cc|h|hpp|gradle|kts|toml|properties|xml|aidl|pro|bat|jar)$' || true)
          else
            DIFF="(initial-build)"
          fi
          echo "ðŸ” Diff detected files:"
          echo "$DIFF"
          if [ "$DIFF" = "(initial-build)" ] || [ -n "$DIFF" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - id: force
        run: |
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "force=true" >> "$GITHUB_OUTPUT"
          else
            echo "force=false" >> "$GITHUB_OUTPUT"
          fi

  review_build:
    name: Review + Build
    runs-on: ubuntu-latest
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' || needs.detect.outputs.force == 'true' }}
    steps:
      # ------------------------------------------------------------
      # ðŸ“¦ Environment Setup
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ inputs.branch || github.ref_name }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          cache: true

      # ------------------------------------------------------------
      # ðŸ’¾ Gradle cache restore
      # ------------------------------------------------------------
      - name: ðŸ’¾ Restore Gradle caches
        id: gradle-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            app/.cxx
            .gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('gradle/libs.versions.toml', 'gradle.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # ------------------------------------------------------------
      # â™»ï¸ Clean Dex transform layers only
      # ------------------------------------------------------------
      - name: â™»ï¸ Clean Gradle transforms (DexSafe)
        run: |
          echo "ðŸ§¹ Cleaning only Dex transform layers..."
          rm -rf ~/.gradle/caches/transforms-* ~/.gradle/caches/jars-* || true
          ./gradlew clean --no-daemon

      # ------------------------------------------------------------
      # ðŸ§ª Review (optional)
      # ------------------------------------------------------------
      - name: ðŸ§ª Review (Lint & Unit Tests)
        if: ${{ inputs.enable_review == true }}
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint failed"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Tests failed"

      # ------------------------------------------------------------
      # ðŸ§  AndroidX + Dex options
      # ------------------------------------------------------------
      - name: ðŸ§  Ensure AndroidX + Dex setup
        run: |
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx3g -XX:+HeapDumpOnOutOfMemoryError" >> gradle.properties
          echo "android.useFullClasspathForDexingTransform=true" >> gradle.properties

      # ------------------------------------------------------------
      # ðŸ—ï¸ Build Release
      # ------------------------------------------------------------
      - name: ðŸ—ï¸ Build Release (DexFull)
        env:
          GRADLE_OPTS: "-Xmx3G -Dorg.gradle.daemon=false"
        run: |
          echo "ðŸ—ï¸ Running Build... (changed=${{ needs.detect.outputs.changed }}, force=${{ needs.detect.outputs.force }})"
          ./gradlew :app:assembleRelease :app:bundleRelease --no-daemon --stacktrace --info

      # ------------------------------------------------------------
      # ðŸ“‚ Collect build outputs (EOF safe)
      # ------------------------------------------------------------
      - id: collect
        run: |
          set -e
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt || true

          if [ ! -s outputs/files.txt ]; then
            echo "::warning::No APK/AAB found"
            echo "files=" >> "$GITHUB_OUTPUT"
          else
            echo "ðŸ“¦ Found build outputs:"
            cat outputs/files.txt
            {
              echo "files<<EOF"
              cat outputs/files.txt
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # ðŸ“¦ Upload release artifacts
      # ------------------------------------------------------------
      - uses: actions/upload-artifact@v4
        if: ${{ steps.collect.outputs.files != '' }}
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

      # ------------------------------------------------------------
      # ðŸ§© Generate meta/models.json
      # ------------------------------------------------------------
      - name: ðŸ“„ Generate meta/models.json
        run: |
          mkdir -p meta
          TAG=${{ needs.detect.outputs.last_tag }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          cat > meta/models.json <<JSON
          {
            "version_tag": "${TAG}",
            "generated": "${DATE}",
            "branch": "${{ inputs.branch || github.ref_name }}",
            "force_build": "${{ inputs.force_build }}",
            "review_enabled": "${{ inputs.enable_review }}",
            "gradle_heap": "3G",
            "dex_full_classpath": true,
            "cache_enabled": true
          }
          JSON
          cat meta/models.json

      - uses: actions/upload-artifact@v4
        with:
          name: meta
          path: meta/
          retention-days: 7

      - name: âœ… Build Finished
        run: |
          echo "âœ… CI Build complete."
          echo "ci-publish.yml will auto-trigger with artifacts + meta/models.json."
