# ============================================================
# âœ… WhispersCpp-Android â€” Full CI/CD Automation (Final Stable v8.2)
# ------------------------------------------------------------
# â€¢ æ‰‹å‹•branché¸æŠï¼ˆæœªæŒ‡å®šæ™‚: ç¾åœ¨branchï¼‰
# â€¢ å¸¸ã« :app ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰
# â€¢ LFSä¸è¦: Whisperãƒ¢ãƒ‡ãƒ«4ç¨®ã‚’è‡ªå‹•DL + assetsåŒæ¢±
# â€¢ Fancy glass-themed downloads page + Wikiæ›´æ–°
# â€¢ SHA256 / ã‚µã‚¤ã‚º / Gitå±¥æ­´ä»˜ã
# ============================================================

name: Android CI & Release (Full + Pages + Wiki)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      create_release:
        description: "Publish Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

# ============================================================
# ğŸ—ï¸ Build & Release
# ============================================================
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 70
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch != '' && inputs.branch || github.head_ref || github.ref_name }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}
          fetch-depth: 0
          lfs: false
          submodules: recursive

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - name: Setup Gradle properties
        run: |
          mkdir -p ~/.gradle
          cat <<'EOF' > ~/.gradle/gradle.properties
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.caching=true
          EOF

      # ======================================================
      # ğŸ“¦ Whisper models auto-download (no LFS required)
      # ======================================================
      - name: Download Whisper models (no LFS)
        run: |
          mkdir -p app/src/main/assets/models
          echo "ğŸ“¦ Downloading Whisper models..."
          declare -A MODELS=(
            ["ggml-base-q5_1.bin"]="https://github.com/ishizuki-tech/WhispersCpp-Android/releases/download/models/ggml-base-q5_1.bin"
            ["ggml-model-q4_0.bin"]="https://github.com/ishizuki-tech/WhispersCpp-Android/releases/download/models/ggml-model-q4_0.bin"
            ["ggml-small-q5_1.bin"]="https://github.com/ishizuki-tech/WhispersCpp-Android/releases/download/models/ggml-small-q5_1.bin"
            ["ggml-tiny-q5_1.bin"]="https://github.com/ishizuki-tech/WhispersCpp-Android/releases/download/models/ggml-tiny-q5_1.bin"
          )
          for name in "${!MODELS[@]}"; do
            url="${MODELS[$name]}"
            echo "â†“ $name"
            curl -L -o "app/src/main/assets/models/$name" "$url"
          done
          echo "--- Downloaded files ---"
          ls -lh app/src/main/assets/models

      # ======================================================
      # ğŸ—ï¸ Build Release APK + AAB
      # ======================================================
      - name: Build Release
        env:
          ORG_GRADLE_PROJECT_android_useAndroidX: "true"
          ORG_GRADLE_PROJECT_android_enableJetifier: "true"
        run: |
          set -euo pipefail
          ./gradlew :${{ env.MODULE_PATH }}:clean :${{ env.MODULE_PATH }}:assembleRelease :${{ env.MODULE_PATH }}:bundleRelease --stacktrace --no-daemon

      - id: collect
        run: |
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) > outputs/files.txt
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat outputs/files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Collected files:"
          cat outputs/files.txt
          echo "--- SHA256 SUMS ---"
          sha256sum $(cat outputs/files.txt)

      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

      - id: version
        run: |
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - id: release
        run: |
          TAG="v${{ steps.version.outputs.version }}-$(date '+%Y%m%d-%H%M')"
          NOTES=$(git log -10 --pretty='* %s (%an)')
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          echo "## What's Changed" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - uses: softprops/action-gh-release@v2
        if: ${{ inputs.create_release == true }}
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: "WhispersCpp Release ${{ steps.version.outputs.version }}"
          body: ${{ steps.release.outputs.body }}
          files: ${{ steps.collect.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # ğŸŒ GitHub Pages â€” Fancy Glass UI
  # ============================================================
  pages:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/

      - name: Setup git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare gh-pages branch
        run: |
          set -e
          if git ls-remote --exit-code origin gh-pages; then
            git clone --branch gh-pages "https://github.com/${{ github.repository }}.git" gh-pages
            cd gh-pages && git pull --rebase || true
          else
            git clone "https://github.com/${{ github.repository }}.git" gh-pages
            cd gh-pages && git checkout --orphan gh-pages
            echo "<h1>Initializing GitHub Pages</h1>" > index.html
            git add index.html && git commit -m "init gh-pages" && git push origin gh-pages
          fi

      - name: Generate fancy downloads page
        run: |
          cd gh-pages
          mkdir -p downloads
          {
            echo "<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'>"
            echo "<meta name='viewport' content='width=device-width'>"
            echo "<title>WhispersCpp Downloads</title>"
            echo "<style>body{font-family:'Segoe UI',sans-serif;margin:0;padding:2em;text-align:center;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;}h1{margin-bottom:.5em;}ul{list-style:none;padding:0;}li{margin:1em 0;}a{color:#58a6ff;text-decoration:none;}a:hover{text-decoration:underline;}code{background:rgba(255,255,255,0.1);padding:2px 5px;border-radius:4px;}footer{margin-top:2em;font-size:.8em;color:#aaa;}</style>"
            echo "</head><body><h1>ğŸ“¦ WhispersCpp Downloads</h1>"
            echo "<p>Generated: $(date '+%Y-%m-%d %H:%M')</p><ul>"
            for f in $(find ../artifacts -type f \( -name '*.apk' -o -name '*.aab' \)); do
              NAME=$(basename "$f")
              SIZE=$(du -h "$f" | cut -f1)
              SHA=$(sha256sum "$f" | cut -d' ' -f1)
              cp "$f" downloads/
              echo "<li><a href='$NAME'>$NAME</a> â€” $SIZE <code>$SHA</code></li>"
            done
            echo "</ul><h2>Recent Commits</h2><pre>"
            git log -10 --pretty='[%h] %s (%an, %cr)'
            echo "</pre><footer><p><a href='https://github.com/${{ github.repository }}/releases'>View Releases</a></p></footer></body></html>"
          } > downloads/index.html

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          commit_message: "Fancy downloads update ($(date '+%Y-%m-%d %H:%M'))"

  # ============================================================
  # ğŸ“˜ GitHub Wiki Auto Update
  # ============================================================
  wiki:
    runs-on: ubuntu-latest
    needs: pages
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/

      - name: Setup git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone Wiki safely
        run: |
          if ! git ls-remote "https://github.com/${{ github.repository }}.wiki.git" &> /dev/null; then
            echo "âš ï¸ Wiki not found. Please create one manually first."
            exit 0
          fi
          git clone "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki
          cd wiki && git pull --rebase || true

      - name: Update Downloads.md
        run: |
          cd wiki
          FILE="Downloads.md"
          TAG=$(git -C .. describe --tags --abbrev=0 2>/dev/null || echo "latest")
          echo "# ğŸ“¦ WhispersCpp-Android Downloads" > "$FILE"
          echo "" >> "$FILE"
          echo "**Branch:** ${{ github.ref_name }}  |  **Tag:** $TAG" >> "$FILE"
          echo "" >> "$FILE"
          echo "Updated: $(date '+%Y-%m-%d %H:%M')" >> "$FILE"
          echo "" >> "$FILE"
          echo "## ğŸ”— Latest Artifacts" >> "$FILE"
          echo "" >> "$FILE"
          for f in $(find ../artifacts -type f \( -name "*.apk" -o -name "*.aab" \)); do
            NAME=$(basename "$f")
            SIZE=$(du -h "$f" | cut -f1)
            SHA=$(sha256sum "$f" | cut -d' ' -f1)
            URL="https://github.com/${{ github.repository }}/releases/latest/download/$NAME"
            echo "- [$NAME]($URL) â€” $SIZE  \`$SHA\`" >> "$FILE"
          done
          echo "" >> "$FILE"
          echo "## ğŸ§¾ Recent Changes" >> "$FILE"
          git -C ../ log -8 --pretty='* %s (%an)' >> "$FILE"

      - name: Commit & Push Wiki
        run: |
          cd wiki
          git add Downloads.md
          git commit -m "Auto-update Wiki Downloads ($(date '+%Y-%m-%d %H:%M'))" || echo "No changes."
          git pull --rebase || true
          git push origin master || git push origin main || true
