# ============================================================
# ‚úÖ WhispersCpp-Android ‚Äî CI/CD (Final Stable v9.6.2 Hybrid Branch Edition)
# ------------------------------------------------------------
# ‚Ä¢ Branch input (main / try / dev etc.)
# ‚Ä¢ Smart Build Skip + MetaAlways + Rich Wiki/Pages
# ‚Ä¢ Fallback ‚Üí Latest successful run or latest Release asset
# ‚Ä¢ Badge: ‚úÖ New / ‚ôªÔ∏è Reused / ü™∂ Fallback
# ============================================================

name: Android CI & Release (Hybrid Branch Edition)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  CURL_UA: "curl/8.x (GitHub Actions; +https://github.com/actions)"
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709

# ============================================================
# üß† Detect Source Changes
# ============================================================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      last_tag: ${{ steps.tag.outputs.last_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - id: tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "ü™∂ Last tag: ${LAST_TAG:-<none>}"

      - id: check
        run: |
          if [ -n "${{ steps.tag.outputs.last_tag }}" ]; then
            CHANGED=$(git diff --name-only ${{ steps.tag.outputs.last_tag }} HEAD app/ nativelib/ | wc -l)
          else
            CHANGED=1
          fi
          if [ "$CHANGED" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Source updated ($CHANGED files)"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "üü° No source changes detected."
          fi

  # ============================================================
  # üß™ Review (optional)
  # ============================================================
  review:
    if: ${{ inputs.enable_review == true && needs.detect.outputs.changed == 'true' }}
    needs: detect
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref_name }}
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - run: ./gradlew :app:lintDebug || echo "::warning::Lint failed"
      - run: ./gradlew :app:testDebugUnitTest || echo "::warning::Tests failed"

  # ============================================================
  # üèóÔ∏è Build (only if changed)
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: [detect, review]
    if: ${{ needs.detect.outputs.changed == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ inputs.branch || github.ref_name }}
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: android-actions/setup-android@v3
      - name: ‚öôÔ∏è Gradle config
        run: |
          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8
          org.gradle.daemon=true
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.configureondemand=true
          EOF
      - name: üß© Build Release
        run: ./gradlew :app:assembleRelease :app:bundleRelease --stacktrace --info
      - id: collect
        run: |
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt
          echo "files<<EOF" >> "$GITHUB_OUTPUT"; cat outputs/files.txt >> "$GITHUB_OUTPUT"; echo "EOF" >> "$GITHUB_OUTPUT"
      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

  # ============================================================
  # üß© Meta (always)
  # ============================================================
  meta:
    runs-on: ubuntu-latest
    needs: [detect]
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
      changed: ${{ needs.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}
      - id: tag
        run: |
          if [ "${{ needs.detect.outputs.changed }}" == "true" ]; then
            TAG="v9.6.2-$(date '+%Y%m%d-%H%M')"
            git tag -a "$TAG" -m "Auto-tag"
            git push origin "$TAG"
          else
            TAG="${{ needs.detect.outputs.last_tag }}"
          fi
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
      - name: üß† Generate Metadata
        run: |
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          jq -n --arg g "$DATE" --arg t "${{ steps.tag.outputs.tag_name }}" '{generated:$g, version_tag:$t}' > meta/models.json
      - uses: actions/upload-artifact@v4
        with: { name: meta, path: meta/models.json }

  # ============================================================
  # üåê Publish (always)
  # ============================================================
  publish:
    runs-on: ubuntu-latest
    needs: [meta]
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref_name }}

      - name: ‚¨áÔ∏è Meta
        uses: actions/download-artifact@v4
        with: { name: meta, path: meta/ }

      - name: ‚¨áÔ∏è Artifact (current)
        id: local
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/
        continue-on-error: true

      - name: üîÑ Last success / Latest release
        if: ${{ steps.local.outcome == 'failure' || hashFiles('artifacts/*') == '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${{ github.repository }}"
          mkdir -p artifacts
          echo "‚ö†Ô∏è Fetching previous successful artifact‚Ä¶"
          RUN_ID=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/runs?status=success&per_page=1" | jq -r '.workflow_runs[0].id')
          if [ "$RUN_ID" != "null" ] && [ -n "$RUN_ID" ]; then
            URL=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/actions/runs/$RUN_ID/artifacts" | \
              jq -r '.artifacts[] | select(.name=="release-artifacts") | .archive_download_url' | head -n1)
            if [ -n "$URL" ]; then
              curl -L -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o artifacts.zip
              unzip -o artifacts.zip -d artifacts
              echo "‚ôªÔ∏è Using last artifact from run #${RUN_ID}" > artifacts/_source.txt
            fi
          fi
          if [ "$(ls -1 artifacts | wc -l)" -eq 0 ]; then
            echo "ü™∂ Trying latest release asset‚Ä¶"
            curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/releases/latest" | \
              jq -r '.assets[] | select(.name|test("apk|aab")) | .browser_download_url' | \
              xargs -I{} bash -c 'curl -L "{}" -o "artifacts/$(basename {})"'
            echo "‚ö†Ô∏è Using fallback: latest release asset" > artifacts/_source.txt
          fi

      - run: sudo apt-get update && sudo apt-get install -y jq

      # ============================================================
      # üìò Generate Wiki + Pages
      # ============================================================
      - name: üìò Generate Wiki + Pages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ needs.meta.outputs.tag_name }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages/downloads

          # „Éê„ÉÉ„Ç∏„ÅÆËá™ÂãïÂàáÊõø
          if [ "${{ needs.meta.outputs.changed }}" == "true" ]; then
            BADGE="‚úÖ New Build"; COLOR="brightgreen"
          elif grep -q "Using last artifact" artifacts/_source.txt 2>/dev/null; then
            BADGE="ü™∂ Fallback Artifact"; COLOR="orange"
          else
            BADGE="‚ôªÔ∏è Reused Build"; COLOR="blue"
          fi

          # Wiki ÁîüÊàê
          {
            echo "# üì¶ WhispersCpp-Android (${TAG})"
            echo "![badge](https://img.shields.io/badge/${BADGE// /_}-${COLOR}.svg)"
            echo
            echo "Updated: ${DATE}"
            echo
            echo "## üß† Metadata"
            jq . meta/models.json
            if [ -f artifacts/_source.txt ]; then
              echo
              echo "> $(cat artifacts/_source.txt)"
              echo
            fi
            echo "## ‚úÖ Latest Artifacts"
            if ls artifacts/*.apk >/dev/null 2>&1 || ls artifacts/*.aab >/dev/null 2>&1; then
              for f in artifacts/*.apk artifacts/*.aab; do
                [ -f "$f" ] || continue
                N=$(basename "$f"); S=$(du -h "$f" | cut -f1); H=$(sha256sum "$f" | cut -d' ' -f1)
                echo "- [$N](https://github.com/${REPO}/releases/latest/download/$N) ‚Äî $S  \`$H\`"
              done
            else
              echo "- (no artifacts available)"
            fi
            echo
            echo "## üïì Release History"
            curl -s -H "Authorization: token ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/releases?per_page=20" | \
              jq -r '.[] | "- [" + .tag_name + "](" + .html_url + ") (" + (.published_at[0:10] // "") + ")"' | sort -r
          } > wiki/Downloads.md

          # Pages („É™„ÉÉ„ÉÅUI)
          cat > gh-pages/downloads/index.html <<HTML
          <!doctype html><html lang="en"><head><meta charset="utf-8">
          <title>üì¶ WhispersCpp-Android Downloads</title>
          <style>
            body{font-family:Inter,system-ui;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;text-align:center;padding:40px;}
            table{margin:auto;border-collapse:collapse;width:92%;background:rgba(255,255,255,.05);}
            th,td{padding:8px 12px;border-bottom:1px solid #333;}a{color:#00eaff;text-decoration:none;}
            input{margin:20px;padding:8px;border-radius:8px;border:1px solid #555;width:260px;background:#111;color:#fff;}
          </style></head><body>
          <h1>üì¶ WhispersCpp-Android</h1>
          <p><img src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${BASE_URL}" width="120"></p>
          <p>Updated: ${DATE} ‚Äî Tag: ${TAG}</p>
          <input type="text" id="search" placeholder="Filter table‚Ä¶">
          <table id="tbl"><tr><th>File</th><th>Size</th><th>SHA256</th></tr></table>
          <script>const rows=[];</script>
          HTML

          if ls artifacts/*.apk >/dev/null 2>&1 || ls artifacts/*.aab >/dev/null 2>&1; then
            for f in artifacts/*.apk artifacts/*.aab; do
              [ -f "$f" ] || continue
              N=$(basename "$f"); S=$(du -h "$f" | cut -f1); H=$(sha256sum "$f" | cut -d' ' -f1)
              echo "          <script>rows.push(['$N','$S','$H']);</script>" >> gh-pages/downloads/index.html
            done
          fi

          cat >> gh-pages/downloads/index.html <<'HTML'
          <script>
            const tbl=document.getElementById('tbl');
            rows.forEach(r=>{let tr=tbl.insertRow();tr.innerHTML=`<td><a href='../${r[0]}'>${r[0]}</a></td><td>${r[1]}</td><td><code>${r[2]}</code></td>`});
            const input=document.getElementById('search');
            input.oninput=e=>{[...tbl.rows].forEach((tr,i)=>{if(i===0)return;tr.style.display=tr.textContent.toLowerCase().includes(e.target.value.toLowerCase())?'':'none';});};
          </script>
          </body></html>
          HTML

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Update Pages (MetaSync ${{ needs.meta.outputs.tag_name }})"

      - name: üìù Push Wiki (master)
        run: |
          REPO="${{ github.repository }}"
          WIKI_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.wiki.git"
          git clone "$WIKI_URL" tempwiki
          cd tempwiki
          git checkout master || git checkout -b master
          cp ../wiki/Downloads.md .
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Downloads.md
          git commit -m "Auto-update Wiki (${{ needs.meta.outputs.tag_name }})" || echo "No changes"
          git push origin master --force
