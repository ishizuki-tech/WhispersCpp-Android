# ============================================================
# ‚úÖ WhispersCpp-Android ‚Äî CI/CD (Final Stable v9.6.7 Debug-Patched + Glass UI)
# ------------------------------------------------------------
# ‚Ä¢ Branch input (main / try / dev)
# ‚Ä¢ Smart Build Skip (strict source diff) + MetaAlways
# ‚Ä¢ Rich Wiki (QR + Release History 20‰ª∂) + Modern Glass Pages
# ‚Ä¢ ‚úÖ Auto fallback when artifact missing
# ‚Ä¢ ‚ôªÔ∏è Use latest Release assets if needed
# ‚Ä¢ üß© Fix git identity + AndroidX auto-enable
# ‚Ä¢ üö´ Tag update ONLY when build ran
# ‚Ä¢ üõ† Review only when build is needed / Verify index.html / Safe fallbacks
# ============================================================

name: Android CI & Release (Fallback-Stable Glass UI)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  CURL_UA: "curl/8.x (GitHub Actions; +https://github.com/actions)"
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709

# ============================================================
# üß† Detect (strict) + optional Review
# ============================================================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      last_tag: ${{ steps.tag.outputs.last_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - id: tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "ü™∂ Last tag: ${LAST_TAG:-<none>}"

      - id: check
        run: |
          set -e
          # 9.6.7 Âü∫Ê∫ñÔºàapp/ „Å® nativelib/ „ÅÆ„ÅøÔºâ„ÄÇ9.6.8 „ÅÆÂé≥ÂØÜÂåñ„ÅØÂà•„Éñ„É©„É≥„ÉÅ„ÅßÊòáÊ†ºÂèØ„ÄÇ
          TARGETS="app/ nativelib/"
          echo "üîç Checking for changes in: $TARGETS"

          if [ -n "${{ steps.tag.outputs.last_tag }}" ]; then
            DIFF=$(git diff --name-only ${{ steps.tag.outputs.last_tag }} HEAD -- $TARGETS \
                    | grep -E '\.(kt|java|ktx|cpp|cc|c|h|hpp|cmake|gradle|kts|xml|aidl|pro)$' || true)
          else
            DIFF="(initial-build)"
          fi

          if [ -n "$DIFF" ] && [ "$DIFF" != "(initial-build)" ]; then
            echo "üß© Changed files:"; echo "$DIFF"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          elif [ "$DIFF" = "(initial-build)" ]; then
            echo "üß© Initial run without tag -> build"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "‚úÖ No source changes detected; skipping build."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
          echo "üìä Done."

  review:
    runs-on: ubuntu-latest
    needs: detect
    # üîí Review „ÅØ„Äå„Éì„É´„Éâ„ÅåÂøÖË¶Å„Å™„Å®„Åç„Å†„Åë„Äç
    if: ${{ inputs.enable_review == true && needs.detect.outputs.changed == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref_name }}
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: android-actions/setup-android@v3
      - name: Lint & Unit tests (non-blocking)
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint failed"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Tests failed"

  # ============================================================
  # üèóÔ∏è Build (only if changed)
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: [detect]
    if: ${{ needs.detect.outputs.changed == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ inputs.branch || github.ref_name }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: android-actions/setup-android@v3

      - name: üß† Ensure AndroidX enabled
        run: |
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties

      - name: üß© Build Release
        run: ./gradlew :app:assembleRelease :app:bundleRelease --stacktrace --info

      - id: collect
        run: |
          set -e
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt
          if [ ! -s outputs/files.txt ]; then
            echo "::warning::No APK/AAB artifacts found."
          fi
          {
            echo "files<<'EOF'"
            cat outputs/files.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        if: ${{ steps.collect.outputs.files != '' }}
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7
          if-no-files-found: warn

  # ============================================================
  # üß© Meta (Tag only when build ran)
  # ============================================================
  meta:
    runs-on: ubuntu-latest
    needs: detect
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
      changed: ${{ needs.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - name: Install jq (for meta json)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - id: tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ "${{ needs.detect.outputs.changed }}" == "true" ]; then
            TAG="v9.6.7-$(date '+%Y%m%d-%H%M')"
            git tag -a "$TAG" -m "Auto-tag (build changed)"
            git push origin "$TAG"
            echo "ü™∂ Tagged new version: $TAG"
          else
            TAG="${{ needs.detect.outputs.last_tag }}"
            if [ -z "$TAG" ]; then TAG="unreleased"; fi
            echo "ü™∂ No source changes ‚Äî keeping tag: $TAG"
          fi
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"

      - name: üß† Meta JSON
        run: |
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          jq -n --arg g "$DATE" --arg t "${{ steps.tag.outputs.tag_name }}" \
            '{generated:$g, version_tag:$t, note:"Meta generated automatically"}' > meta/models.json

      - uses: actions/upload-artifact@v4
        with:
          name: meta
          path: meta/models.json

  # ============================================================
  # üåê Publish (Release + Pages + Wiki) with Fallback
  # ============================================================
  publish:
    runs-on: ubuntu-latest
    needs: [meta]
    if: ${{ inputs.create_release == true }}
    steps:
      - name: üîß Ensure gh/jq/unzip installed
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh jq unzip || true

      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref_name }}

      - name: ‚¨áÔ∏è Download Meta
        uses: actions/download-artifact@v4
        with:
          name: meta
          path: meta/

      - name: ‚¨áÔ∏è Try download current artifacts
        id: try_art
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: release-artifacts
          path: artifacts/

      - name: ‚ôªÔ∏è Fallback to latest successful artifacts or release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          mkdir -p artifacts
          REPO="${{ github.repository }}"

          if [ -z "$(ls -A artifacts 2>/dev/null || true)" ]; then
            echo "ü™∂ No current artifacts; fetching previous successful run..."
            RUN_ID=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/actions/runs?status=success&per_page=1" | jq -r '.workflow_runs[0].id')
            if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
              URL=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
                "https://api.github.com/repos/${REPO}/actions/runs/$RUN_ID/artifacts" | \
                jq -r '.artifacts[] | select(.name=="release-artifacts") | .archive_download_url' | head -n1)
              if [ -n "$URL" ]; then
                curl -L -H "Authorization: Bearer ${GH_TOKEN}" "$URL" -o artifacts.zip
                unzip -o artifacts.zip -d artifacts
                echo "‚ôªÔ∏è Using last successful artifact from run #${RUN_ID}"
              fi
            fi
          fi

          if [ -z "$(ls -A artifacts 2>/dev/null || true)" ]; then
            echo "ü™∂ Still no artifacts; will use latest release assets for listing"
            curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/releases/latest" > release.json || true
            if [ -s release.json ]; then
              jq -r '.assets[] | select(.name|test("\\.(apk|aab)$")) | [.name, (.size|tostring), .browser_download_url] | @tsv' release.json \
                > artifacts/_release_assets.tsv || true
            fi
          fi

      - name: üöÄ Create/Update Release (only if we actually built artifacts)
        if: ${{ needs.meta.outputs.changed == 'true' && hashFiles('artifacts/*.apk','artifacts/*.aab') != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.tag_name }}
          name: "WhispersCpp Release ${{ needs.meta.outputs.tag_name }}"
          files: |
            artifacts/*.apk
            artifacts/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üåà Generate Modern Glass UI Page + Wiki (QR + History 20)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG=${{ needs.meta.outputs.tag_name }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages/downloads

          # ---------- Wiki ----------
          {
            echo "# üì¶ WhispersCpp-Android (${TAG})"
            echo "Updated: ${DATE}"
            echo
            cat meta/models.json
            echo
            echo "## üß© Build Artifacts"
            if [ -f artifacts/_release_assets.tsv ]; then
              echo "_Using latest release assets_"
              while IFS=$'\t' read -r N S U; do
                echo "- [$N]($U) ‚Äî ${S} bytes"
              done < artifacts/_release_assets.tsv
            else
              shopt -s nullglob
              COUNT=0
              for f in artifacts/*.apk artifacts/*.aab; do
                [ -f "$f" ] || continue
                N=$(basename "$f"); S=$(du -h "$f" | cut -f1); H=$(sha256sum "$f" | cut -d' ' -f1)
                echo "- [$N](https://github.com/${REPO}/releases/download/${TAG}/$N) ‚Äî $S \`$H\`"
                COUNT=$((COUNT+1))
              done
              if [ "$COUNT" -eq 0 ]; then
                echo "- _No files yet ‚Äî build artifacts not found_"
              fi
              shopt -u nullglob
            fi
            echo
            echo "## üïì Release History"
            echo "> Last 20 releases on GitHub"
            curl -s -H "Authorization: token ${GH_TOKEN}" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${REPO}/releases?per_page=20" \
              | jq -r '.[] | "- [" + (.name // .tag_name) + "](" + .html_url + ") (" + (.published_at[0:10]) + ")"' || echo "- (History unavailable.)"
            echo
            echo "<div align=\"center\">"
            echo "<img src=\"https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${BASE_URL}\" alt=\"QR\" width=\"180\" height=\"180\"><br>"
            echo "üîó <a href=\"${BASE_URL}\">Open Glass UI Downloads Page</a>"
            echo "</div>"
          } > wiki/Downloads.md

          # ---------- Pages (Glass UI) ----------
          cat > gh-pages/downloads/index.html <<HTML
          <!doctype html>
          <html lang="en"><head><meta charset="utf-8"/>
          <title>üì¶ WhispersCpp-Android Downloads</title>
          <meta name="viewport" content="width=device-width,initial-scale=1"/>
          <style>
            body{font-family:'Inter',system-ui;background:radial-gradient(circle at top left,#1b2735,#090a0f);
            color:#e0e0e0;text-align:center;padding:40px;margin:0}
            .glass{background:rgba(255,255,255,0.08);border-radius:20px;box-shadow:0 4px 40px rgba(0,0,0,0.3);
            backdrop-filter:blur(12px);padding:30px;margin:40px auto;width:92%;max-width:960px;}
            table{width:100%;border-collapse:collapse;margin-top:20px;}
            th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.1);}
            tr:hover{background-color:rgba(255,255,255,0.05);}
            a{color:#00eaff;text-decoration:none;}a:hover{text-decoration:underline;}
            footer{margin-top:30px;font-size:0.85em;color:#aaa;}
          </style></head><body>
            <div class="glass">
              <p><a href="../index.html" target=_self title="Seperate Page">Go to index</a></p>
              <h1>üì¶ WhispersCpp-Android</h1>
              <p><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" width="110" height="110" alt="QR"></p>
              <p>Tag: ${TAG} &nbsp;‚Ä¢&nbsp; Updated: ${DATE}</p>
              <table><tr><th>File</th><th>Size</th><th>SHA256</th></tr>
          HTML

          if [ -f artifacts/_release_assets.tsv ]; then
            while IFS=$'\t' read -r N S U; do
              echo "<tr><td><a href=\"$U\">$N</a></td><td>${S}</td><td>‚Äî</td></tr>" >> gh-pages/downloads/index.html
            done < artifacts/_release_assets.tsv
          else
            shopt -s nullglob
            COUNT=0
            for f in artifacts/*.apk artifacts/*.aab; do
              if [ -f "$f" ]; then
                N=$(basename "$f"); S=$(du -h "$f" | cut -f1); H=$(sha256sum "$f" | cut -d' ' -f1)
                echo "<tr><td><a href=\"https://github.com/${REPO}/releases/download/${TAG}/${N}\">${N}</a></td><td>${S}</td><td><code>${H}</code></td></tr>" >> gh-pages/downloads/index.html
                COUNT=$((COUNT+1))
              fi
            done
            if [ "$COUNT" -eq 0 ]; then
              echo "<tr><td colspan=\"3\"><em>No files yet ‚Äî build artifacts not found</em></td></tr>" >> gh-pages/downloads/index.html
            fi
            shopt -u nullglob
          fi

          cat >> gh-pages/downloads/index.html <<'HTML'
              </table>
              <footer>Generated automatically by CI/CD v9.6.7 Debug-Patched</footer>
            </div></body></html>
          HTML

      - name: ‚úÖ Verify downloads page generated
        run: |
          echo "üìÅ ls -R gh-pages/downloads"
          ls -R gh-pages/downloads || true
          if [ ! -f gh-pages/downloads/index.html ]; then
            echo "::error::downloads/index.html is missing. Page generation failed."
            exit 1
          fi

      - name: üìò Push Wiki
        run: |
          set -e
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          WIKI_URL="https://${ACTOR}:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.wiki.git"
          rm -rf wiki.push && cp -r wiki wiki.push
          cd wiki.push
          git init
          git config user.name "${ACTOR}"
          git config user.email "${ACTOR}@users.noreply.github.com"
          git add Downloads.md
          git commit -m "Auto-update Wiki (QR + artifacts + history v9.6.7 Debug-Patched)"
          git branch -M master
          git remote add origin "$WIKI_URL"
          git push origin master --force

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Update Pages (v9.6.7 Debug-Patched)"
