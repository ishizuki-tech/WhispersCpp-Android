# ============================================================
# ‚úÖ WhispersCpp-Android ‚Äî Full CI/CD Automation (Final Stable v6.8)
# ------------------------------------------------------------
# ‚Ä¢ Code Review ‚Üí Build ‚Üí Release(HTML+QR) ‚Üí Pages ‚Üí Wiki
# ‚Ä¢ LFSÁÑ°ÂäπÂåñ / WikiÂàùÂõû„Çπ„Ç≠„ÉÉ„Éó / gh-pagesËá™ÂãïÁîüÊàê ÂÆâÂÆöÂåñÊ∏à„Åø
# ‚Ä¢ Release„Éö„Éº„Ç∏„Å´QR‰ªò„Åçdownloads.html„ÇíËá™ÂãïÊ∑ª‰ªò
# ============================================================

name: Android CI & Release (Full + Pages + Wiki + QR HTML)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

# ============================================================
# üß† Build + Release
# ============================================================
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 70
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false
          submodules: recursive
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3
        with:
          ndk-version: 28.0.12433566

      - name: Accept SDK licenses
        run: |
          mkdir -p "$ANDROID_SDK_ROOT/licenses"
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_SDK_ROOT/licenses/android-sdk-license"

      - name: Build Release
        run: ./gradlew :app:assembleRelease :app:bundleRelease --stacktrace --no-daemon

      - id: collect
        run: |
          mkdir -p artifacts
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) -exec cp {} artifacts/ \;
          ls artifacts

      - id: version
        run: |
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - id: html
        name: Generate downloads.html (QR + size + hash)
        run: |
          mkdir -p html
          OUT="html/downloads.html"
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>WhispersCpp Downloads</title>' > "$OUT"
          echo '<style>body{font-family:sans-serif;background:#f9fafc;padding:2rem}li{margin:1rem 0}img{vertical-align:middle}</style></head><body>' >> "$OUT"
          echo "<h1>üì¶ WhispersCpp-Android Downloads</h1><p>Generated: $(date '+%Y-%m-%d %H:%M')</p><ul>" >> "$OUT"
          for f in artifacts/*; do
            [ -f "$f" ] || continue
            name=$(basename "$f")
            size=$(du -h "$f" | cut -f1)
            sha=$(sha256sum "$f" | cut -d' ' -f1)
            enc=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$name'))")
            url="https://github.com/${{ github.repository }}/releases/latest/download/${enc}"
            qr="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=$url"
            echo "<li><a href='$url'>$name</a> ‚Äî $size<br><img src='$qr' width='100'><br><code>$sha</code></li>" >> "$OUT"
          done
          echo "</ul></body></html>" >> "$OUT"

      - id: tag
        run: |
          TS=$(date '+%Y%m%d-%H%M')
          TAG="v${{ steps.version.outputs.version }}-${TS}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          echo "## What's Changed" >> "$GITHUB_OUTPUT"
          git log -10 --pretty='* %s (%an)' >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            artifacts/*
            html/downloads.html

      - name: Publish GitHub Release (with HTML)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "WhispersCpp Release ${{ steps.version.outputs.version }}"
          body: ${{ steps.tag.outputs.body }}
          files: |
            artifacts/*
            html/downloads.html
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # üåê GitHub Pages
  # ============================================================
  pages:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git.config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare gh-pages
        run: |
          git clone --branch gh-pages "https://github.com/${{ github.repository }}" gh-pages || (
            git clone "https://github.com/${{ github.repository }}" gh-pages &&
            cd gh-pages &&
            git checkout --orphan gh-pages &&
            echo "<h1>Initializing GitHub Pages</h1>" > index.html &&
            git add index.html &&
            git commit -m "init gh-pages" &&
            git push origin gh-pages
          )

      - name: Copy artifacts + generate HTML
        run: |
          mkdir -p gh-pages/downloads
          cp app/build/outputs/**/*.apk gh-pages/downloads/ 2>/dev/null || true
          cp app/build/outputs/**/*.aab gh-pages/downloads/ 2>/dev/null || true
          cp html/downloads.html gh-pages/downloads/index.html || true

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          commit_message: "Auto-update downloads ($(date '+%Y-%m-%d %H:%M'))"

  # ============================================================
  # üìò GitHub Wiki
  # ============================================================
  wiki:
    runs-on: ubuntu-latest
    needs: [build, pages]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone gh-pages for file list
        run: |
          git clone --branch gh-pages "https://github.com/${{ github.repository }}" ghp
          ls -la ghp/downloads || true

      - name: Check Wiki exists
        run: |
          if ! git ls-remote "https://github.com/${{ github.repository }}.wiki.git" &> /dev/null; then
            echo "‚ö†Ô∏è Wiki not initialized. Skipping update."
            exit 0
          fi

      - name: Clone Wiki
        run: git clone "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki

      - name: Update Downloads.md
        run: |
          cd wiki
          FILE="Downloads.md"
          OWNER_REPO="${{ github.repository }}"
          OWNER="${OWNER_REPO%%/*}"
          REPO="${OWNER_REPO##*/}"
          PAGES_BASE="https://${OWNER}.github.io/${REPO}/downloads"
          echo "# üì¶ WhispersCpp-Android Downloads" > "$FILE"
          echo "" >> "$FILE"
          echo "Updated: $(date '+%Y-%m-%d %H:%M')" >> "$FILE"
          echo "" >> "$FILE"
          echo "## üîó Latest Artifacts (via GitHub Pages)" >> "$FILE"
          echo "" >> "$FILE"
          if [ -d ../ghp/downloads ]; then
            for f in ../ghp/downloads/*.apk ../ghp/downloads/*.aab; do
              [ -f "$f" ] || continue
              name=$(basename "$f")
              enc=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$name'))")
              size=$(du -h "$f" | cut -f1)
              sha=$(sha256sum "$f" | cut -d' ' -f1)
              echo "- [$name](${PAGES_BASE}/${enc}) ‚Äî ${size}  \`${sha}\`" >> "$FILE"
            done
          else
            echo "_No downloads yet._" >> "$FILE"
          fi
          echo "" >> "$FILE"
          echo "## üßæ Recent Changes" >> "$FILE"
          echo "" >> "$FILE"
          git -C "$GITHUB_WORKSPACE" log -10 --pretty='* %s (%an)' >> "$FILE"

      - name: Commit & Push Wiki
        run: |
          cd wiki
          git add Downloads.md
          git commit -m "Auto-update Wiki Downloads.md ($(date '+%Y-%m-%d %H:%M'))" || echo "No changes."
          git push origin main || git push origin master || true
