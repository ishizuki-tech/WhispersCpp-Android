# ============================================================
# âœ… WhispersCpp-Android â€” Full CI/CD Automation (Final Stable v8.5)
# ------------------------------------------------------------
# â€¢ branchæ‰‹å‹•é¸æŠï¼ˆæœªæŒ‡å®šæ™‚: tryï¼‰
# â€¢ appãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ãƒ“ãƒ«ãƒ‰
# â€¢ Pages: Fancy Glass UI + model/ABI info è¡¨ç¤º
# â€¢ Wiki/Releaseé€£æº + AndroidXå¼·åˆ¶
# ============================================================

name: Android CI & Release (Full + Fancy Pages + Wiki)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: try)"
        required: false
        default: "try"
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false
defaults:
  run:
    shell: bash

# ============================================================
# ğŸ§  Review
# ============================================================
jobs:
  review:
    runs-on: ubuntu-latest
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch }}
    steps:
      - uses: actions/checkout@v4
        with: { ref: ${{ env.BRANCH_NAME }} }
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: 17 }
      - run: |
          ./gradlew :app:lintDebug || true
          ./gradlew :app:testDebugUnitTest || true

  # ============================================================
  # ğŸ—ï¸ Build & Release
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: review
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}
          fetch-depth: 0
          lfs: false
          submodules: recursive
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: 17 }
      - uses: android-actions/setup-android@v3

      - name: Gradle props
        run: |
          mkdir -p ~/.gradle
          cat <<'EOF' > ~/.gradle/gradle.properties
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          EOF

      # --------------------------------------------------------
      # ğŸ“¦ Download Whisper models from try branch (raw)
      # --------------------------------------------------------
      - name: Download Whisper models
        run: |
          mkdir -p app/src/main/assets/models
          declare -A MODELS=(
            ["ggml-base-q5_1.bin"]="https://raw.githubusercontent.com/ishizuki-tech/WhispersCpp-Android/try/app/src/main/assets/models/ggml-base-q5_1.bin"
            ["ggml-model-q4_0.bin"]="https://raw.githubusercontent.com/ishizuki-tech/WhispersCpp-Android/try/app/src/main/assets/models/ggml-model-q4_0.bin"
            ["ggml-small-q5_1.bin"]="https://raw.githubusercontent.com/ishizuki-tech/WhispersCpp-Android/try/app/src/main/assets/models/ggml-small-q5_1.bin"
            ["ggml-tiny-q5_1.bin"]="https://raw.githubusercontent.com/ishizuki-tech/WhispersCpp-Android/try/app/src/main/assets/models/ggml-tiny-q5_1.bin"
          )
          for name in "${!MODELS[@]}"; do
            curl -fL -o "app/src/main/assets/models/$name" "${MODELS[$name]}"
          done
          echo "âœ… Models downloaded:"; ls -lh app/src/main/assets/models

      - name: Build Release
        run: ./gradlew :app:clean :app:assembleRelease :app:bundleRelease --stacktrace --no-daemon

      - id: collect
        run: |
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) > outputs/files.txt
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat outputs/files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          sha256sum $(cat outputs/files.txt)

      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

      - id: version
        run: |
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - id: release
        run: |
          TAG="v${{ steps.version.outputs.version }}-$(date '+%Y%m%d-%H%M')"
          NOTES=$(git log -6 --pretty='* %s (%an)')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "## What's Changed"; echo "$NOTES"; echo "EOF" >> $GITHUB_OUTPUT

      - uses: softprops/action-gh-release@v2
        if: ${{ inputs.create_release == true }}
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: "WhispersCpp Release ${{ steps.version.outputs.version }}"
          body: ${{ steps.release.outputs.body }}
          files: ${{ steps.collect.outputs.files }}
        env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }

  # ============================================================
  # ğŸŒ Fancy GitHub Pages
  # ============================================================
  pages:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: release-artifacts, path: artifacts }

      - name: Generate fancy downloads
        run: |
          mkdir -p gh-pages/downloads
          cat > gh-pages/downloads/index.html <<'HTML'
          <!doctype html>
          <html lang="en">
          <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width,initial-scale=1">
          <title>ğŸ“¦ WhispersCpp-Android Downloads</title>
          <style>
            body{font-family:Inter,system-ui;text-align:center;margin:0;padding:40px;background:linear-gradient(145deg,#101820,#203A43,#2C5364);color:#fff;}
            h1{margin-bottom:10px;}
            .card{backdrop-filter:blur(16px);background:rgba(255,255,255,0.08);border-radius:20px;padding:24px;margin:20px auto;width:80%;max-width:700px;box-shadow:0 8px 32px rgba(0,0,0,.3);}
            ul{list-style:none;padding:0;}
            li{margin:10px 0;}
            a{color:#00eaff;text-decoration:none;font-weight:600;}
            a:hover{text-decoration:underline;}
            code{background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:6px;}
            footer{opacity:.7;margin-top:30px;font-size:.8em;}
          </style>
          </head><body>
          <h1>ğŸ“¦ WhispersCpp-Android Downloads</h1>
          <p>Generated: $(date '+%Y-%m-%d %H:%M')</p>
          <div class="card"><h2>Release Artifacts</h2><ul>
          HTML

          for f in $(find artifacts -type f \( -name "*.apk" -o -name "*.aab" \)); do
            NAME=$(basename "$f"); SIZE=$(du -h "$f"|cut -f1)
            SHA=$(sha256sum "$f"|cut -d' ' -f1)
            echo "<li><a href='$NAME'>$NAME</a> â€” $SIZE <code>$SHA</code></li>" >> gh-pages/downloads/index.html
          done

          echo "</ul></div><div class='card'><h2>Embedded Models (ABI info)</h2><ul>" >> gh-pages/downloads/index.html
          for m in $(find app/src/main/assets/models -type f -name "*.bin" 2>/dev/null); do
            MNAME=$(basename "$m"); MSIZE=$(du -h "$m"|cut -f1)
            ABI=$(echo "$MNAME"|grep -Eo 'q[0-9_]+')
            echo "<li>$MNAME â€” $MSIZE <code>$ABI</code></li>" >> gh-pages/downloads/index.html
          done
          echo "</ul></div><footer>Generated automatically by GitHub Actions â€¢ $(date '+%Y-%m-%d')</footer></body></html>" >> gh-pages/downloads/index.html

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          commit_message: "Update fancy downloads page ($(date '+%Y-%m-%d %H:%M'))"

  # ============================================================
  # ğŸ“˜ Wiki Sync
  # ============================================================
  wiki:
    runs-on: ubuntu-latest
    needs: pages
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: release-artifacts, path: artifacts }

      - name: Clone Wiki
        run: |
          if ! git ls-remote "https://github.com/${{ github.repository }}.wiki.git" &> /dev/null; then
            echo "âš ï¸ Wiki not found"; exit 0; fi
          git clone "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki

      - name: Update Downloads.md
        run: |
          cd wiki
          echo "# ğŸ“¦ WhispersCpp-Android Downloads" > Downloads.md
          echo "Updated: $(date '+%Y-%m-%d %H:%M')" >> Downloads.md
          echo "" >> Downloads.md
          for f in $(find ../artifacts -type f \( -name "*.apk" -o -name "*.aab" \)); do
            N=$(basename "$f"); S=$(du -h "$f"|cut -f1); H=$(sha256sum "$f"|cut -d' ' -f1)
            echo "- [$N](https://github.com/${{ github.repository }}/releases/latest/download/$N) â€” $S  \`$H\`" >> Downloads.md
          done
          git add Downloads.md
          git commit -m "Auto-update Downloads ($(date '+%Y-%m-%d %H:%M'))" || true
          git push origin master || git push origin main || true
