# ============================================================
# âœ… WhispersCpp-Android â€” CI/CD (Final Stable v9.3.2)
# ------------------------------------------------------------
# â€¢ Auto Model Download + Safe Check (Hugging Face + Jacaranda)
# â€¢ Auto AndroidX + QR Code + Release History
# â€¢ Pages & Wiki Link-Only (no large files)
# ============================================================

name: Android CI & Release (Auto Model + QR + History)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        default: ""
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  CURL_UA: "curl/8.x (GitHub Actions; +https://github.com/actions)"

# ============================================================
# ðŸ§  Review
# ============================================================
jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enforce AndroidX
        run: |
          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.caching=true
          EOF
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: Lint & Unit tests (non-blocking)
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint failed"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Tests failed"

  # ============================================================
  # ðŸ—ï¸ Build & Release
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: review
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Enforce AndroidX
        run: |
          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.caching=true
          EOF

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - name: Download Whisper models (auto + safe)
        run: |
          set -euo pipefail
          mkdir -p app/src/main/assets/models
          cd app/src/main/assets/models
          echo "ðŸ“¦ Downloading Whisper models..."

          download() {
            name="$1"; shift
            urls=("$@")
            for u in "${urls[@]}"; do
              echo "â†’ Trying $u"
              if curl -fSL -A "curl/8.x (GitHub Actions)" --retry 3 --retry-delay 2 -o "$name.tmp" "$u"; then
                mv "$name.tmp" "$name"
                size=$(du -h "$name" | cut -f1)
                echo "âœ… Downloaded $name ($size)"
                return 0
              fi
            done
            echo "::error::Failed to fetch $name"
            return 1
          }

          download ggml-tiny-q5_1.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny-q5_1.bin" \
            "https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-tiny-q5_1.bin"

          download ggml-base-q5_1.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base-q5_1.bin" \
            "https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-base-q5_1.bin"

          download ggml-small-q5_1.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small-q5_1.bin"

          download ggml-model-q4_0.bin \
            "https://huggingface.co/jboat/jacaranda-asr-whispercpp/resolve/main/ggml-model-q4_0.bin"

          echo "--- Downloaded files ---"
          ls -lh

      - name: Build Release
        run: |
          ./gradlew -Pandroid.useAndroidX=true -Pandroid.enableJetifier=true :app:assembleRelease :app:bundleRelease --stacktrace --no-daemon

      - id: collect
        name: Collect Artifacts
        run: |
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt
          echo "files<<EOF" >> "$GITHUB_OUTPUT"; cat outputs/files.txt >> "$GITHUB_OUTPUT"; echo "EOF" >> "$GITHUB_OUTPUT"
          echo "--- SHA256 ---"; xargs -a outputs/files.txt -r sha256sum

      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

      - id: version
        run: |
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - id: release
        run: |
          TAG="v${{ steps.version.outputs.version }}-$(date '+%Y%m%d-%H%M')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - uses: softprops/action-gh-release@v2
        if: ${{ inputs.create_release == true }}
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: "WhispersCpp Release ${{ steps.version.outputs.version }}"
          files: ${{ steps.collect.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # ðŸŒ Pages (QR + Model Info + History)
  # ============================================================
  pages:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/

      - name: Generate HTML (QR + Model Info)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p gh-pages/downloads
          REPO="${{ github.repository }}"
          BASE_URL="https://${{ github.repository_owner }}.github.io/$(basename ${REPO})/"
          QR_URL="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${BASE_URL}"
          GEN_TIME=$(date '+%Y-%m-%d %H:%M')
          curl -s -H "Authorization: token ${GH_TOKEN}" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/repos/${REPO}/releases?per_page=20" > gh-pages/releases.json

          cat > gh-pages/downloads/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
          <title>ðŸ“¦ WhispersCpp-Android Downloads</title>
          <style>
            body{font-family:Inter,system-ui;text-align:center;margin:0;padding:40px;background:linear-gradient(145deg,#0f2027,#203a43,#2c5364);color:#fff;}
            h1{margin-bottom:12px;}h2{margin-top:32px;}
            ul{list-style:none;padding:0;}
            a{color:#00eaff;text-decoration:none;font-weight:600;}
            a:hover{text-decoration:underline;}
            footer{opacity:.7;margin-top:40px;font-size:.85em;}
            .qr img{margin:24px auto;border-radius:12px;transition:transform .3s;box-shadow:0 0 10px #00eaff;}
            .qr img:hover{transform:scale(1.12);}
            .desc{opacity:.85;font-size:.9em;margin-bottom:10px;}
          </style></head><body>
          <h1>ðŸ“¦ WhispersCpp-Android Downloads</h1>
          <div class="qr">
            <img src="${QR_URL}" alt="QR code">
            <div class="desc"><a href="${BASE_URL}" style="color:#88eaff">${BASE_URL}</a></div>
            <div class="desc">ðŸ“± Scan on your phone to open directly</div>
          </div>
          <p>Generated: ${GEN_TIME}</p>

          <h2>ðŸŽ§ Whisper Model Specifications</h2>
          <ul>
            <li><b>ggml-tiny-q5_1.bin</b> â€” <a href="https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny-q5_1.bin">source</a><br>
              Multilingual (EN/JP/SW) â€¢ 39M params â€¢ 20MB â€¢ ~32Ã— RT</li>
            <li><b>ggml-base-q5_1.bin</b> â€” <a href="https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base-q5_1.bin">source</a><br>
              Balanced â€¢ 74M params â€¢ 57MB â€¢ ~16Ã— RT</li>
            <li><b>ggml-small-q5_1.bin</b> â€” <a href="https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small-q5_1.bin">source</a><br>
              High accuracy â€¢ 244M params â€¢ 182MB â€¢ ~6Ã— RT</li>
            <li><b>ggml-model-q4_0.bin</b> â€” <a href="https://huggingface.co/jboat/jacaranda-asr-whispercpp/resolve/main/ggml-model-q4_0.bin">source</a><br>
              Swahili-tuned â€¢ 74M params â€¢ 61MB â€¢ ~14Ã— RT</li>
          </ul>

          <h2>Latest Release</h2><ul>
          HTML

          find artifacts -type f \( -name "*.apk" -o -name "*.aab" \) -printf "<li><a href='https://github.com/${REPO}/releases/latest/download/%f'>%f</a></li>\n" | sort >> gh-pages/downloads/index.html
          echo "</ul><h2>Release History</h2><ul>" >> gh-pages/downloads/index.html
          jq -r '.[] | "- <a href=\"\(.html_url)\">\(.name // .tag_name)</a> (" + (.published_at[0:10]) + ")"' gh-pages/releases.json | sed 's/$/<br>/' >> gh-pages/downloads/index.html
          echo "</ul><footer>Files hosted on GitHub Releases â€¢ ${GEN_TIME}</footer></body></html>" >> gh-pages/downloads/index.html

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Update QR + model info + release history"

  # ============================================================
  # ðŸ“˜ Wiki Sync
  # ============================================================
  wiki:
    runs-on: ubuntu-latest
    needs: pages
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/
      - name: Clone Wiki
        run: |
          if ! git ls-remote "https://github.com/${{ github.repository }}.wiki.git" &> /dev/null; then
            echo "âš ï¸ Wiki not found; skipping."; exit 0; fi
          git clone "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki

      - name: Update Downloads.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          WIKI_URL="https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.wiki.git"

          echo "ðŸ“˜ Cloning Wiki..."
          git clone "$WIKI_URL" wiki
          cd wiki

          echo "# ðŸ“¦ WhispersCpp-Android Downloads" > Downloads.md
          echo "Updated: $(date '+%Y-%m-%d %H:%M')" >> Downloads.md
          echo "" >> Downloads.md
          echo "## ðŸŽ§ Whisper Model Specifications" >> Downloads.md
          echo "| Model | Params | Size | Speed | Notes | Source |" >> Downloads.md
          echo "|:--|:--|:--|:--|:--|:--|" >> Downloads.md
          echo "| ggml-tiny-q5_1.bin | 39M | 20MB | ~32Ã— RT | Multilingual (EN/JP/SW) | [Hugging Face](https://huggingface.co/ggerganov/whisper.cpp/blob/main/ggml-tiny-q5_1.bin) |" >> Downloads.md
          echo "| ggml-base-q5_1.bin | 74M | 57MB | ~16Ã— RT | Balanced multilingual | [Hugging Face](https://huggingface.co/ggerganov/whisper.cpp/blob/main/ggml-base-q5_1.bin) |" >> Downloads.md
          echo "| ggml-small-q5_1.bin | 244M | 182MB | ~6Ã— RT | High accuracy | [Hugging Face](https://huggingface.co/ggerganov/whisper.cpp/blob/main/ggml-small-q5_1.bin) |" >> Downloads.md
          echo "| ggml-model-q4_0.bin | 74M | 61MB | ~14Ã— RT | Swahili-tuned | [Jacaranda ASR](https://huggingface.co/jboat/jacaranda-asr-whispercpp/blob/main/ggml-model-q4_0.bin) |" >> Downloads.md
          echo "" >> Downloads.md
          echo "## âœ… Latest Files" >> Downloads.md
          find ../artifacts -type f \( -name "*.apk" -o -name "*.aab" \) -print0 | sort -z | while IFS= read -r -d '' f; do
            N=$(basename "$f"); S=$(du -h "$f"|cut -f1); H=$(sha256sum "$f"|cut -d' ' -f1)
            echo "- [$N](https://github.com/${REPO}/releases/latest/download/$N) â€” $S  \`$H\`" >> Downloads.md
          done
          echo "" >> Downloads.md
          echo "## ðŸ•“ Historical Releases" >> Downloads.md
          curl -s -H "Authorization: token ${GH_TOKEN}" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases?per_page=20" | \
            jq -r '.[] | "- [" + (.name // .tag_name) + "](" + .html_url + ") (" + (.published_at[0:10]) + ")"' >> Downloads.md

          echo "âœ… Commit and push to Wiki..."
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add Downloads.md
          git commit -m "Auto-update Wiki (QR + model info + history $(date '+%Y-%m-%d %H:%M'))" || echo "No changes."
          git branch -M main
          git push "$WIKI_URL" main --force
