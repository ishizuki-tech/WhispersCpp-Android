# ============================================================
# âœ… WhispersCpp-Android â€” Full CI/CD Automation (Final Stable v8.6.3)
# ------------------------------------------------------------
# â€¢ æ‰‹å‹• branch é¸æŠï¼ˆæœªæŒ‡å®š â†’ ç¾åœ¨ãƒ–ãƒ©ãƒ³ãƒã¸è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
# â€¢ app ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ãƒ“ãƒ«ãƒ‰
# â€¢ ggml-model-q4_0.bin ã¯ã€Œtryãƒ–ãƒ©ãƒ³ãƒã®è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆrawï¼‰ã€ã‚’ PRIMARY ã«ä½¿ç”¨
# â€¢ Whisper models: å®Ÿä½“DL + æœ€ä½ã‚µã‚¤ã‚ºæ¤œè¨¼ + ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ
# â€¢ Pages: Fancy Glass UI + å®Ÿä½“ãƒ•ã‚¡ã‚¤ãƒ«é…ç½® + SHA ã‚¯ãƒªãƒƒã‚¯ã‚³ãƒ”ãƒ¼
# â€¢ Wiki/Release åŒæœŸ + AndroidX å¼·åˆ¶ + rebase å®‰å…¨åŒ–
# â€¢ Gradle ã‚­ãƒ£ãƒƒã‚·ãƒ¥
# ============================================================

name: Android CI & Release (Full + Fancy Pages + Wiki)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

# ============================================================
# ğŸ§  Review
# ============================================================
jobs:
  review:
    runs-on: ubuntu-latest
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME || github.ref_name }}
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: Lint & UnitTest (non-blocking with warnings)
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint failed (continuing pipeline)"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Unit tests failed (continuing pipeline)"

  # ============================================================
  # ğŸ—ï¸ Build & Release
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: review
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME || github.ref_name }}
          fetch-depth: 0
          lfs: false
          submodules: recursive

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties','**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Gradle properties
        run: |
          mkdir -p ~/.gradle
          cat <<'EOF' > ~/.gradle/gradle.properties
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.caching=true
          EOF

      # ======================================================
      # ğŸ“¦ Whisper models download (robust)
      #   - ggml-model-q4_0.bin â†’ PRIMARY: Shu's try branch raw URLï¼ˆã”æŒ‡å®šï¼‰
      #   - ãã®ã»ã‹: Hugging Face â†’ whisper.cpp/models ã®é †
      #   - Verify minimum sizeï¼ˆLFSãƒã‚¤ãƒ³ã‚¿/ç ´ææ¤œçŸ¥ï¼‰
      #   - PRIVATE repo ã®å ´åˆã¯ GITHUB_TOKEN ãƒ˜ãƒƒãƒ€è‡ªå‹•ä»˜ä¸å¯¾å¿œ
      # ======================================================
      - name: Download Whisper models (robust; ggml-model-q4_0 from try branch)
        env:
          GH_RAW_TRY_Q4_0: https://raw.githubusercontent.com/ishizuki-tech/WhispersCpp-Android/try/app/src/main/assets/models/ggml-model-q4_0.bin
          GH_RELEASE_Q4_0: https://github.com/ishizuki-tech/WhispersCpp-Android/releases/latest/download/ggml-model-q4_0.bin
        run: |
          set -euo pipefail
          mkdir -p app/src/main/assets/models
          cd app/src/main/assets/models
          echo "ğŸ“¦ Downloading Whisper ggml models with verification..."

          # ä¿å­˜åï¼ˆã‚¢ãƒ—ãƒªãŒæœŸå¾…ã™ã‚‹åå‰ï¼‰ â†’ å–å¾—URL
          declare -A SRC_PRIMARY=(
            ["ggml-tiny-q5_1.bin"]="https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.bin"
            ["ggml-base-q5_1.bin"]="https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin"
            ["ggml-small-q5_1.bin"]="https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small.bin"
            # ğŸ‘‡ ã”æŒ‡å®šã® try ãƒ–ãƒ©ãƒ³ãƒã® raw ã‚’ PRIMARY
            ["ggml-model-q4_0.bin"]="${GH_RAW_TRY_Q4_0}"
          )
          declare -A SRC_FALLBACK=(
            ["ggml-tiny-q5_1.bin"]="https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-tiny.bin"
            ["ggml-base-q5_1.bin"]="https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-base.bin"
            ["ggml-small-q5_1.bin"]="https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-small.bin"
            # ğŸ‘‡ PRIMARY ãŒå¤±æ•—/å°ã‚µã‚¤ã‚ºã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            ["ggml-model-q4_0.bin"]="${GH_RELEASE_Q4_0}"
          )

          # æœ€ä½ã‚µã‚¤ã‚ºé–¾å€¤ï¼ˆå®‰å…¨å´ã®ã–ã£ãã‚ŠåŸºæº–ï¼‰
          declare -A MIN_BYTES=(
            ["ggml-tiny-q5_1.bin"]=$((10 * 1024 * 1024))    # >10MB
            ["ggml-base-q5_1.bin"]=$((60 * 1024 * 1024))    # >60MB
            ["ggml-small-q5_1.bin"]=$((200 * 1024 * 1024))  # >200MB
            ["ggml-model-q4_0.bin"]=$((60 * 1024 * 1024))   # >60MBï¼ˆè‹±èªbaseç›¸å½“æƒ³å®šï¼‰
          )

          # private repo å¯¾å¿œ: GITHUB_TOKEN ãŒã‚ã‚‹å ´åˆã®ã¿ Authorization ãƒ˜ãƒƒãƒ€ä»˜ä¸
          curl_dl () {
            local url="$1" out="$2"
            if [ -n "${GITHUB_TOKEN:-}" ] && [[ "$url" == https://raw.githubusercontent.com/* || "$url" == https://github.com/* ]]; then
              curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" -o "$out" "$url"
            else
              curl -fsSL -o "$out" "$url"
            fi
          }

          download_verify () {
            local name="$1"
            local url_primary="$2"
            local url_fallback="$3"
            local min_bytes="$4"

            echo "ğŸ“¥ ${name} â† PRIMARY"
            if ! curl_dl "$url_primary" "${name}.tmp"; then
              echo "âš ï¸ PRIMARY failed, trying FALLBACK..."
              curl_dl "$url_fallback" "${name}.tmp"
            fi

            local sz
            sz=$(wc -c < "${name}.tmp" || echo 0)
            echo "   size=${sz} bytes (min=${min_bytes})"
            if [ "$sz" -lt "$min_bytes" ]; then
              echo "âŒ Size below threshold â€” likely LFS pointer or truncated. Retrying FALLBACK..."
              rm -f "${name}.tmp"
              # FALLBACKã‚’å†è©¦è¡Œï¼ˆæ—¢ã«FALLBACKã‹ã‚‰å–å¾—ã—ã¦ã„ã‚‹å ´åˆã¯ã“ã®ã¾ã¾å¤±æ•—ï¼‰
              if ! curl_dl "$url_fallback" "${name}.tmp"; then
                echo "âŒ FALLBACK download failed."
                return 1
              fi
              sz=$(wc -c < "${name}.tmp" || echo 0)
              echo "   fallback-size=${sz} bytes (min=${min_bytes})"
              if [ "$sz" -lt "$min_bytes" ]; then
                echo "âŒ FALLBACK also below threshold."
                rm -f "${name}.tmp"
                return 1
              fi
            fi

            mv "${name}.tmp" "${name}"
            echo "âœ… ${name} OK"
          }

          set +e
          ok_all=1
          for name in "${!SRC_PRIMARY[@]}"; do
            download_verify "$name" "${SRC_PRIMARY[$name]}" "${SRC_FALLBACK[$name]}" "${MIN_BYTES[$name]}"
            if [ $? -ne 0 ]; then ok_all=0; fi
          done
          set -e

          echo "--- Downloaded files ---"
          ls -lh

          if [ $ok_all -ne 1 ]; then
            echo "::error::One or more Whisper model downloads failed verification."
            exit 1
          fi

      # ======================================================
      # ğŸ—ï¸ Build Release APK + AAB
      # ======================================================
      - name: Build Release
        env:
          ORG_GRADLE_PROJECT_android_useAndroidX: "true"
          ORG_GRADLE_PROJECT_android_enableJetifier: "true"
        run: |
          set -euo pipefail
          ./gradlew :${{ env.MODULE_PATH }}:clean :${{ env.MODULE_PATH }}:assembleRelease :${{ env.MODULE_PATH }}:bundleRelease --stacktrace --no-daemon

      - id: collect
        name: Collect artifacts (APK/AAB + SHA256)
        run: |
          set -euo pipefail
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat outputs/files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Collected files:"
          cat outputs/files.txt
          echo "--- SHA256 SUMS ---"
          xargs -a outputs/files.txt -r sha256sum

      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

      - id: version
        name: Extract versionName
        run: |
          set -euo pipefail
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - id: release
        name: Prepare release notes
        run: |
          set -euo pipefail
          TAG="v${{ steps.version.outputs.version }}-$(date '+%Y%m%d-%H%M')"
          NOTES=$(git log -10 --pretty='* %s (%an)' || true)
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          {
            echo "body<<'EOF'"
            echo "## What's Changed"
            echo "${NOTES}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - uses: softprops/action-gh-release@v2
        if: ${{ inputs.create_release == true }}
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: "WhispersCpp Release ${{ steps.version.outputs.version }}"
          body: ${{ steps.release.outputs.body }}
          files: ${{ steps.collect.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # ğŸŒ GitHub Pages â€” Fancy Glass UI
  # ============================================================
  pages:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/

      - name: Generate fancy downloads HTML (and copy artifacts)
        run: |
          set -euo pipefail
          mkdir -p gh-pages/downloads
          # å®Ÿä½“ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼ï¼ˆHTMLã‹ã‚‰ç›´æ¥DLå¯ï¼‰
          while IFS= read -r f; do
            [ -f "$f" ] || continue
            cp -f "$f" "gh-pages/downloads/$(basename "$f")"
          done < <(find artifacts -type f \( -name "*.apk" -o -name "*.aab" \) | sort)

          # HTMLç”Ÿæˆ
          GEN_TIME=$(date '+%Y-%m-%d %H:%M')
          cat > gh-pages/downloads/index.html <<HTML
          <!doctype html>
          <html lang="en"><head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width,initial-scale=1">
          <title>ğŸ“¦ WhispersCpp-Android Downloads</title>
          <style>
            body{font-family:Inter,system-ui;text-align:center;margin:0;padding:40px;
              background:linear-gradient(145deg,#0f2027,#203a43,#2c5364);color:#fff;}
            h1{margin-bottom:12px;}
            .card{backdrop-filter:blur(14px);background:rgba(255,255,255,0.07);
              border-radius:20px;padding:22px;margin:20px auto;width:80%;max-width:740px;
              box-shadow:0 8px 32px rgba(0,0,0,.35);}
            ul{list-style:none;padding:0;margin:0;}
            li{margin:8px 0;}
            a{color:#00eaff;text-decoration:none;font-weight:600;}
            a:hover{text-decoration:underline;}
            code{background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:6px;cursor:pointer;}
            footer{opacity:.7;margin-top:30px;font-size:.8em;}
          </style>
          <script>
            function copySHA(sha){
              navigator.clipboard.writeText(sha);
              alert("SHA256 copied:\\n" + sha);
            }
          </script>
          </head><body>
          <h1>ğŸ“¦ WhispersCpp-Android Downloads</h1>
          <p>Generated: ${GEN_TIME}</p>
          <div class="card"><h2>Release Artifacts</h2><ul>
          HTML

          # ãƒªã‚¹ãƒˆé …ç›®
          for f in $(find gh-pages/downloads -maxdepth 1 -type f \( -name "*.apk" -o -name "*.aab" \) -printf "%f\n" | sort); do
            SIZE=$(du -h "gh-pages/downloads/$f" | cut -f1)
            SHA=$(sha256sum "gh-pages/downloads/$f" | cut -d' ' -f1)
            echo "<li><a href='$f'>$f</a> â€” $SIZE <code onclick=\"copySHA('$SHA')\">$SHA</code></li>" >> gh-pages/downloads/index.html
          done

          echo "</ul></div><footer>Generated automatically â€¢ $(date '+%Y-%m-%d')</footer></body></html>" >> gh-pages/downloads/index.html

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          commit_message: "Update fancy downloads page ($(date '+%Y-%m-%d %H:%M'))"

  # ============================================================
  # ğŸ“˜ Wiki Sync
  # ============================================================
  wiki:
    runs-on: ubuntu-latest
    needs: pages
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts

      - name: Clone Wiki (skip if not exists)
        run: |
          if ! git ls-remote "https://github.com/${{ github.repository }}.wiki.git" &> /dev/null; then
            echo "âš ï¸ Wiki not found; skipping."; exit 0; fi
          git clone "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki

      - name: Update Downloads.md
        run: |
          set -euo pipefail
          cd wiki
          echo "# ğŸ“¦ WhispersCpp-Android Downloads" > Downloads.md
          echo "Updated: $(date '+%Y-%m-%d %H:%M')" >> Downloads.md
          echo "" >> Downloads.md
          find ../artifacts -type f \( -name "*.apk" -o -name "*.aab" \) -print0 \
            | sort -z \
            | while IFS= read -r -d '' f; do
                N=$(basename "$f"); S=$(du -h "$f"|cut -f1); H=$(sha256sum "$f"|cut -d' ' -f1)
                echo "- [$N](https://github.com/${{ github.repository }}/releases/latest/download/$N) â€” $S  \`$H\`" >> Downloads.md
              done
          git add Downloads.md
          git commit -m "Auto-update Downloads ($(date '+%Y-%m-%d %H:%M'))" || true
          git pull --rebase || true
          git push origin master || git push origin main || true
