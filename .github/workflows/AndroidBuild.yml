name: Android CI & Release

on:
  workflow_dispatch:
    inputs:
      module:
        description: "Android module to build (e.g. app)"
        default: "app"
      create_release:
        description: "Publish GitHub Release with built artifacts"
        type: boolean
        default: true
      ndk_version:
        description: "Android NDK version"
        default: "28.0.12433566"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    env:
      MODULE_PATH: ${{ inputs.module || 'app' }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ORG_GRADLE_PROJECT_releaseStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ORG_GRADLE_PROJECT_releaseKeyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
      ORG_GRADLE_PROJECT_releaseKeyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      # =======================================================
      # ‚úÖ Checkout source & submodules
      # =======================================================
      - name: Checkout source (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GH_TOKEN }}

      - name: Initialize & verify submodules
        run: |
          set -e
          echo "üîß Configure git safety & sync submodules"
          git config --global --add safe.directory '*'
          git submodule sync --recursive || true

          echo "‚¨áÔ∏è  Update submodules"
          if ! git submodule update --init --recursive; then
            echo "::warning::Submodule init failed; will fallback to manual clone."
          fi

          echo "üìã Current submodule status (may be empty):"
          git submodule status || true

          # Fallback clone if whisper.cpp is missing or empty
          if [[ ! -f nativelib/whisper.cpp/src/whisper.cpp ]]; then
            echo "::warning::Submodule 'nativelib/whisper.cpp' missing; cloning ggml-org/whisper.cpp..."
            rm -rf nativelib/whisper.cpp
            git clone --depth=1 https://github.com/ggml-org/whisper.cpp.git nativelib/whisper.cpp
          fi

          echo "üß± whisper.cpp HEAD revision:"
          (cd nativelib/whisper.cpp && git rev-parse --short HEAD || echo "no git repo")

      # =======================================================
      # üîß Android / Java
      # =======================================================
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Ensure gradlew is executable
        run: chmod +x ./gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Install Android SDK & NDK
        uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ inputs.ndk_version }}

      - name: Install Android build tools
        run: |
          set -e
          yes | sdkmanager --install \
            "platforms;android-36" \
            "build-tools;36.0.0" \
            "platform-tools" || true
          echo "‚úÖ Android SDK/NDK installation complete."

      - name: Export NDK env
        run: |
          echo "ANDROID_NDK_HOME=${ANDROID_NDK_HOME}" >> $GITHUB_ENV
          echo "PATH=${ANDROID_NDK_HOME}:${PATH}" >> $GITHUB_ENV

      # =======================================================
      # üß∞ Gradle configuration
      # =======================================================
      - name: Configure Gradle cache
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-home-cache-strategy: gradle-user-home

      - name: Write gradle.properties
        run: |
          set -e
          if [[ -z "${{ secrets.GH_TOKEN }}" ]]; then
            echo "::error::GH_TOKEN missing. Set it in repository secrets."
            exit 1
          fi

          mkdir -p "$HOME/.gradle"
          cat > "$HOME/.gradle/gradle.properties" <<'PROPS'
          # =====================================
          # ‚úÖ Global Gradle Configuration
          # =====================================
          android.useAndroidX=true
          android.enableJetifier=true

          # GitHub upload defaults (used by any custom tasks)
          gh.owner=ishizuki-tech
          gh.repo=WhispersCpp-Android
          gh.branch=main
          gh.pathPrefix=exports
          gh.token=${GH_TOKEN}

          # Optional for model downloads, etc.
          HF_TOKEN=${HF_TOKEN}

          # Gradle runtime
          org.gradle.daemon=false
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          PROPS
          echo "‚úÖ gradle.properties configured."

      # =======================================================
      # üîê Keystore (optional)
      # =======================================================
      - name: Decode signing keystore
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > keystore.jks
          echo "ANDROID_KEYSTORE_FILE=$PWD/keystore.jks" >> $GITHUB_ENV
          echo "‚úÖ Keystore decoded."

      # =======================================================
      # üß© Verify native / CMake structure (fail early)
      # =======================================================
      - name: Verify whisper.cpp and JNI CMake structure
        run: |
          set -e
          echo "üìÇ Working Directory: $(pwd)"
          echo "üîé Listing JNI directory (if present):"
          find nativelib/src/main -maxdepth 5 -type f \( -name 'CMakeLists.txt' -o -name '*.cpp' -o -name '*.c' -o -name '*.h' \) | sort || true

          # Accept either location:
          if [[ -f nativelib/src/main/jni/whisper/CMakeLists.txt ]]; then
            echo "‚úÖ Found JNI CMakeLists at nativelib/src/main/jni/whisper/CMakeLists.txt"
          elif [[ -f nativelib/src/main/cpp/CMakeLists.txt ]]; then
            echo "‚úÖ Found JNI CMakeLists at nativelib/src/main/cpp/CMakeLists.txt"
          else
            echo "::error::No JNI CMakeLists.txt found under nativelib/src/main/{jni/whisper,cpp}"
            exit 1
          fi

          # Sanity check whisper.cpp sources
          test -d nativelib/whisper.cpp/src || (echo "::error::Missing nativelib/whisper.cpp/src" && exit 1)
          find nativelib/whisper.cpp/src -maxdepth 1 -type f -name '*.cpp' | head -n 5

      # =======================================================
      # üß† Build (Gradle)
      # =======================================================
      - name: Print Gradle projects
        run: ./gradlew projects --no-daemon

      - name: Build release artifacts
        run: |
          set -e
          echo "üöÄ Building Android module: $MODULE_PATH"
          ./gradlew \
            :${MODULE_PATH}:clean \
            :${MODULE_PATH}:assembleRelease \
            :${MODULE_PATH}:bundleRelease \
            --no-daemon --stacktrace --info
          echo "‚úÖ Build completed."

      # =======================================================
      # üì¶ Collect build outputs
      # =======================================================
      - name: Collect build outputs
        id: collect
        run: |
          set -e
          ROOT="${MODULE_PATH}/build/outputs"
          echo "üì¶ Scanning build outputs under $ROOT ..."
          APKs=$(find "$ROOT" -type f -name '*.apk' -print | sort || true)
          AABs=$(find "$ROOT" -type f -name '*.aab' -print | sort || true)
          MAPs=$(find "${MODULE_PATH}/build/outputs/mapping" -type f -name 'mapping.txt' -print | sort || true)

          echo "Found APKs:"; echo "$APKs"
          echo "Found AABs:"; echo "$AABs"
          echo "Found MAPs:"; echo "$MAPs"

          {
            echo "apk_list<<'EOF'"
            echo "$APKs"
            echo "EOF"
            echo "aab_list<<'EOF'"
            echo "$AABs"
            echo "EOF"
            echo "map_list<<'EOF'"
            echo "$MAPs"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # =======================================================
      # ‚òÅÔ∏è Upload artifacts
      # =======================================================
      - name: Upload APKs
        if: ${{ steps.collect.outputs.apk_list != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: ${{ steps.collect.outputs.apk_list }}
          retention-days: 14

      - name: Upload AABs
        if: ${{ steps.collect.outputs.aab_list != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: ${{ steps.collect.outputs.aab_list }}
          retention-days: 14

      - name: Upload mapping files
        if: ${{ steps.collect.outputs.map_list != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: proguard-mapping
          path: ${{ steps.collect.outputs.map_list }}
          retention-days: 14

      # =======================================================
      # üß© Derive version & release tag
      # =======================================================
      - name: Derive version
        id: version
        run: |
          set -e
          FILE_GRADLE="${MODULE_PATH}/build.gradle.kts"
          VERSION=""
          if [[ -f "$FILE_GRADLE" ]]; then
            # Try versionName = "x.y.z"
            VERSION=$(grep -E 'versionName\s*=\s*".*"' "$FILE_GRADLE" | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || true)
            # Fallback: versionName "x.y.z"
            if [[ -z "$VERSION" ]]; then
              VERSION=$(grep -E 'versionName\s+"[^"]+"' "$FILE_GRADLE" | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || true)
            fi
          fi
          if [[ -z "$VERSION" ]]; then
            echo "::warning::Could not parse versionName. Using 0.0.0"
            VERSION="0.0.0"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Derived version: $VERSION"

      - name: Compute release tag
        id: tag
        run: |
          set -e
          TS="$(date '+%Y%m%d-%H%M')"
          TAG="v${{ steps.version.outputs.version }}-${TS}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "üè∑Ô∏è Generated tag: $TAG"

      # =======================================================
      # üìù Prepare release notes
      # =======================================================
      - name: Prepare release notes
        id: notes
        run: |
          set -e
          NOTES="$(git log -20 --pretty='* %s (%an)')"
          {
            echo "body<<'EOF'"
            echo "## What's Changed"
            echo
            if [[ -n "$NOTES" ]]; then
              echo "$NOTES"
            else
              echo "* Initial release"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "üßæ Release notes prepared."

      # =======================================================
      # üö¢ Publish GitHub Release
      # =======================================================
      - name: Publish GitHub Release
        if: ${{ inputs.create_release && (steps.collect.outputs.apk_list != '' || steps.collect.outputs.aab_list != '') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body: ${{ steps.notes.outputs.body }}
          files: |
            ${{ steps.collect.outputs.apk_list }}
            ${{ steps.collect.outputs.aab_list }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Skip release (no artifacts or disabled)
        if: ${{ !inputs.create_release || (steps.collect.outputs.apk_list == '' && steps.collect.outputs.aab_list == '') }}
        run: |
          echo "Release creation skipped (input=false or no build artifacts)."
