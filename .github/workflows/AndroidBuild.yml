# ============================================================
# âœ… WhispersCpp-Android â€” CI/CD (Final Stable v9.6.3 Modern Glass UI Edition)
# ------------------------------------------------------------
# â€¢ Branch input (main / try / dev)
# â€¢ Smart Build Skip + MetaAlways
# â€¢ Rich Wiki + Modern Glass Pages
# â€¢ QR + Dynamic Filter + SHA Hover Animation
# ============================================================

name: Android CI & Release (Modern Glass UI Edition)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  CURL_UA: "curl/8.x (GitHub Actions; +https://github.com/actions)"
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709

# ============================================================
# ðŸ§  Detect + Tag
# ============================================================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      last_tag: ${{ steps.tag.outputs.last_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}
      - id: tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "ðŸª¶ Last tag: ${LAST_TAG:-<none>}"
      - id: check
        run: |
          if [ -n "${{ steps.tag.outputs.last_tag }}" ]; then
            CHANGED=$(git diff --name-only ${{ steps.tag.outputs.last_tag }} HEAD app/ nativelib/ | wc -l)
          else
            CHANGED=1
          fi
          echo "changed=$([ "$CHANGED" -gt 0 ] && echo true || echo false)" >> "$GITHUB_OUTPUT"

  # ============================================================
  # ðŸ—ï¸ Build
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ inputs.branch || github.ref_name }}
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: android-actions/setup-android@v3
      - name: ðŸ§© Build Release
        run: ./gradlew :app:assembleRelease :app:bundleRelease --stacktrace --info
      - id: collect
        run: |
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt
          echo "files<<EOF" >> "$GITHUB_OUTPUT"; cat outputs/files.txt >> "$GITHUB_OUTPUT"; echo "EOF" >> "$GITHUB_OUTPUT"
      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

  # ============================================================
  # ðŸ§© Meta
  # ============================================================
  meta:
    runs-on: ubuntu-latest
    needs: detect
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
      changed: ${{ needs.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}
      - id: tag
        run: |
          if [ "${{ needs.detect.outputs.changed }}" == "true" ]; then
            TAG="v9.6.3-$(date '+%Y%m%d-%H%M')"
            git tag -a "$TAG" -m "Auto-tag"
            git push origin "$TAG"
          else
            TAG="${{ needs.detect.outputs.last_tag }}"
          fi
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
      - name: ðŸ§  Meta JSON
        run: |
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          jq -n --arg g "$DATE" --arg t "${{ steps.tag.outputs.tag_name }}" \
            '{generated:$g, version_tag:$t, note:"Meta generated automatically"}' > meta/models.json
      - uses: actions/upload-artifact@v4
        with:
          name: meta
          path: meta/models.json

  # ============================================================
  # ðŸŒ Publish
  # ============================================================
  publish:
    runs-on: ubuntu-latest
    needs: [meta]
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref_name }}

      - name: â¬‡ï¸ Download Meta
        uses: actions/download-artifact@v4
        with:
          name: meta
          path: meta/

      - name: â¬‡ï¸ Download Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: release-artifacts
          path: artifacts/

      - run: sudo apt-get update && sudo apt-get install -y jq

      - name: ðŸŒˆ Generate Modern Glass UI Page + Wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG=${{ needs.meta.outputs.tag_name }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages/downloads

          echo "# ðŸ“¦ WhispersCpp-Android (${TAG})" > wiki/Downloads.md
          echo "Updated: ${DATE}\n" >> wiki/Downloads.md
          jq . meta/models.json >> wiki/Downloads.md

          # Modern HTML page
          cat > gh-pages/downloads/index.html <<HTML
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8"/>
            <title>ðŸ“¦ WhispersCpp-Android Downloads</title>
            <style>
              :root {--glass-bg: rgba(255,255,255,0.08);}
              body {
                font-family: 'Inter',system-ui;
                background: radial-gradient(circle at top left,#1b2735,#090a0f);
                color: #e0e0e0;
                text-align: center;
                padding: 40px;
              }
              .glass {
                background: var(--glass-bg);
                border-radius: 20px;
                box-shadow: 0 4px 40px rgba(0,0,0,0.3);
                backdrop-filter: blur(12px);
                padding: 30px;
                margin: auto;
                width: 85%;
                max-width: 900px;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
              }
              th, td {
                padding: 12px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
              }
              tr:hover {background-color: rgba(255,255,255,0.05);}
              a {color: #00eaff; text-decoration:none;}
              a:hover {text-decoration:underline;}
              input {
                background:#0d1117; border:1px solid #333; color:#fff;
                border-radius:8px; padding:8px; width:250px; margin-top:12px;
              }
              footer{margin-top:30px;font-size:0.85em;color:#aaa;}
              .badge {
                display:inline-block; padding:6px 12px; border-radius:12px;
                background:linear-gradient(90deg,#00eaff,#007bff);
                color:#000; font-weight:600; margin-bottom:15px;
              }
              .dark-toggle {
                position:fixed; top:15px; right:15px;
                cursor:pointer; background:#222; border-radius:50%;
                width:32px; height:32px; display:flex;
                align-items:center; justify-content:center;
              }
            </style>
          </head>
          <body>
            <div class="dark-toggle" onclick="toggleTheme()">ðŸŒ™</div>
            <div class="glass">
              <h1>ðŸ“¦ WhispersCpp-Android</h1>
              <div class="badge">Tag: ${TAG}</div>
              <p><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" width="100"></p>
              <p>Updated: ${DATE}</p>
              <input id="search" placeholder="Filter file...">
              <table id="tbl"><tr><th>File</th><th>Size</th><th>SHA256</th></tr></table>
              <footer>Generated automatically for ${OWNER}/${REPO}</footer>
            </div>
            <script>
              const files = [];
            </script>
          HTML

          for f in artifacts/*.apk artifacts/*.aab; do
            [ -f "$f" ] || continue
            N=$(basename "$f"); S=$(du -h "$f" | cut -f1); H=$(sha256sum "$f" | cut -d' ' -f1)
            echo "            <script>files.push(['$N','$S','$H']);</script>" >> gh-pages/downloads/index.html
          done

          cat >> gh-pages/downloads/index.html <<'HTML'
            <script>
              const tbl=document.getElementById('tbl');
              files.forEach(f=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`<td><a href='../${f[0]}'>${f[0]}</a></td><td>${f[1]}</td><td><code>${f[2]}</code></td>`;
                tbl.appendChild(tr);
              });
              const inp=document.getElementById('search');
              inp.oninput=e=>[...tbl.rows].forEach((tr,i)=>{if(i===0)return;tr.style.display=tr.textContent.toLowerCase().includes(e.target.value.toLowerCase())?'':'none';});
              function toggleTheme(){
                document.body.style.background=document.body.style.background.includes('#fff')?
                'radial-gradient(circle at top left,#1b2735,#090a0f)':'#fff';
                document.body.style.color=document.body.style.color=='#000'?'#e0e0e0':'#000';
              }
            </script>
          </body></html>
          HTML

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Update Pages (v9.6.3 Glass UI)"
