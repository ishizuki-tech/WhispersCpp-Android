# ============================================================
# ‚úÖ WhispersCpp-Android ‚Äî Full CI/CD Automation (Final Stable v7.3)
# ------------------------------------------------------------
# ‚Ä¢ branch„ÇíÊâãÂãïÈÅ∏ÊäûÂèØËÉΩÔºàÊú™ÊåáÂÆöÊôÇ„ÅØÁèæÂú®„ÅÆbranchÔºâ
# ‚Ä¢ Â∏∏„Å´ app „É¢„Ç∏„É•„Éº„É´„Çí„Éì„É´„Éâ
# ‚Ä¢ downloads/index.html ‰øÆÊ≠£Áâà + SHA256Ë°®Á§∫
# ‚Ä¢ LFSÁÑ°ÂäπÂåñ / WikiËá™ÂãïÊõ¥Êñ∞ / gh-pagesÂÆâÂÆöÂãï‰Ωú
# ============================================================

name: Android CI & Release (Full + Pages + Wiki)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true
      ndk_version:
        description: "Android NDK version"
        required: false
        default: "28.0.12433566"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

# ============================================================
# üß† Code Review
# ============================================================
jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch != '' && inputs.branch || github.head_ref || github.ref_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: gradle/wrapper-validation-action@v2

      - uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Run Lint
        id: lint
        run: ./gradlew :${{ env.MODULE_PATH }}:lintDebug || true

      - name: Run Unit Tests
        id: test
        run: ./gradlew :${{ env.MODULE_PATH }}:testDebugUnitTest || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-report
          path: app/build/reports/lint-results.html

  # ============================================================
  # üèóÔ∏è Build + Release
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: review
    timeout-minutes: 70
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch != '' && inputs.branch || github.head_ref || github.ref_name }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}
          lfs: false
          fetch-depth: 0
          submodules: recursive

      - name: Accept Android SDK Licenses
        run: |
          mkdir -p "$ANDROID_SDK_ROOT/licenses"
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_SDK_ROOT/licenses/android-sdk-license"

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ inputs.ndk_version }}

      - name: Install SDK components
        run: |
          sdkmanager --install "platforms;android-35" "build-tools;35.0.0" "platform-tools" || true

      - uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            app/.cxx
            nativelib/.cxx
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/CMakeLists.txt') }}

      - name: Setup gradle.properties
        run: |
          mkdir -p ~/.gradle
          cat > ~/.gradle/gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.caching=true
          EOF

      - if: env.ANDROID_KEYSTORE_BASE64 != ''
        name: Decode keystore
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > keystore.jks
          echo "ANDROID_KEYSTORE_FILE=$PWD/keystore.jks" >> $GITHUB_ENV

      - name: Build Release
        run: |
          ./gradlew :${{ env.MODULE_PATH }}:clean :${{ env.MODULE_PATH }}:assembleRelease :${{ env.MODULE_PATH }}:bundleRelease --stacktrace --no-daemon

      - id: collect
        run: |
          ROOT="${MODULE_PATH}/build/outputs"
          mkdir -p outputs_list
          find "$ROOT" -type f \( -name '*.apk' -o -name '*.aab' \) > outputs_list/files.txt
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat outputs_list/files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 14

      - id: version
        run: |
          FILE="${MODULE_PATH}/build.gradle.kts"
          VERSION=$(grep -E 'versionName' "$FILE" | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - id: release
        run: |
          TS=$(date '+%Y%m%d-%H%M')
          TAG="v${{ steps.version.outputs.version }}-${TS}"
          NOTES=$(git log -10 --pretty='* %s (%an)')
          {
            echo "tag=$TAG"
            echo "body<<EOF"
            echo "## What's Changed"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - uses: softprops/action-gh-release@v2
        if: ${{ inputs.create_release == true }}
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: "WhispersCpp Release ${{ steps.version.outputs.version }}"
          body: ${{ steps.release.outputs.body }}
          files: ${{ steps.collect.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # üåê GitHub Pages
  # ============================================================
  pages:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ inputs.create_release == true }}
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch != '' && inputs.branch || github.head_ref || github.ref_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}
          fetch-depth: 0

      - name: Setup Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone or create gh-pages
        run: |
          if git ls-remote --exit-code origin gh-pages; then
            git clone --branch gh-pages "https://github.com/${{ github.repository }}.git" gh-pages
          else
            git clone "https://github.com/${{ github.repository }}.git" gh-pages
            cd gh-pages
            git checkout --orphan gh-pages
            echo "<h1>Initializing GitHub Pages</h1>" > index.html
            git add index.html
            git commit -m "init gh-pages"
            git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages
          fi

      - name: Generate downloads index (fixed)
        run: |
          cd gh-pages
          mkdir -p downloads
          HTML="downloads/index.html"
          echo "<html><body><h1>üì¶ WhispersCpp-Android Downloads</h1><p>Branch: ${{ env.BRANCH_NAME }}</p><p>Generated: $(date '+%Y-%m-%d %H:%M')</p><ul>" > "$HTML"
          for f in $(find ../${{ env.MODULE_PATH }}/build/outputs -type f \( -name '*.apk' -o -name '*.aab' \)); do
            NAME=$(basename "$f")
            cp "$f" "downloads/$NAME"
            SIZE=$(du -h "$f" | cut -f1)
            SHA=$(sha256sum "$f" | cut -d' ' -f1)
            echo "<li><a href='$NAME'>$NAME</a> ‚Äî $SIZE <code>$SHA</code></li>" >> "$HTML"
          done
          echo "</ul></body></html>" >> "$HTML"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          commit_message: "Auto-update downloads index ($(date '+%Y-%m-%d %H:%M'))"

  # ============================================================
  # üìò GitHub Wiki
  # ============================================================
  wiki:
    runs-on: ubuntu-latest
    needs: [build, pages]
    if: ${{ inputs.create_release == true }}
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch != '' && inputs.branch || github.head_ref || github.ref_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}
          fetch-depth: 20

      - name: Setup Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure Wiki exists
        run: |
          if ! git ls-remote "https://github.com/${{ github.repository }}.wiki.git" &> /dev/null; then
            echo "‚ö†Ô∏è Wiki not found. Please create first page manually."
            exit 0
          fi

      - name: Clone Wiki
        run: git clone "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki

      - name: Update Downloads.md
        run: |
          cd wiki
          FILE="Downloads.md"
          echo "# üì¶ WhispersCpp-Android Downloads" > "$FILE"
          echo "" >> "$FILE"
          echo "Branch: ${{ env.BRANCH_NAME }}" >> "$FILE"
          echo "Updated: $(date '+%Y-%m-%d %H:%M')" >> "$FILE"
          echo "" >> "$FILE"
          echo "## üîó Latest Artifacts" >> "$FILE"
          echo "" >> "$FILE"
          for f in $(find ../${{ env.MODULE_PATH }}/build/outputs -type f \( -name '*.apk' -o -name '*.aab' \) 2>/dev/null); do
            NAME=$(basename "$f")
            SIZE=$(du -h "$f" | cut -f1)
            SHA=$(sha256sum "$f" | cut -d' ' -f1)
            URL="https://github.com/${{ github.repository }}/releases/latest/download/$NAME"
            echo "- [$NAME]($URL) ‚Äî $SIZE  \`$SHA\`" >> "$FILE"
          done
          echo "" >> "$FILE"
          echo "## üßæ Recent Changes" >> "$FILE"
          git -C ../ log -10 --pretty='* %s (%an)' >> "$FILE"

      - name: Commit & Push Wiki
        run: |
          cd wiki
          git add Downloads.md
          git commit -m "Auto-update Wiki Downloads.md ($(date '+%Y-%m-%d %H:%M'))" || echo "No changes."
          git push origin master || true
