# ============================================================
# âœ… WhispersCpp-Android â€” CI/CD (Final Stable v9.4.4 Hybrid Meta-Sync + ReviewToggle + Debug)
# ------------------------------------------------------------
# â€¢ Safe NDK install + Auto Model Download
# â€¢ meta/models.json â†’ Pages + Wiki(master)
# â€¢ workflow_dispatch: Review(Lint/Test) toggle
# â€¢ Fixed: dynamic `needs` evaluation bug (always starts)
# â€¢ Improved Gradle memory (-Xmx4g / 1GB MetaSpace)
# â€¢ Enhanced debug logs + graceful fail
# ============================================================

name: Android CI & Release (Hybrid Meta-Sync + Review Toggle + Debug)

on:
  workflow_dispatch:
    inputs:
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  CURL_UA: "curl/8.x (GitHub Actions; +https://github.com/actions)"
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709

jobs:
  # ============================================================
  # ðŸ§  Review (optional)
  # ============================================================
  review:
    if: ${{ inputs.enable_review == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure Gradle memory and AndroidX
        run: |
          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError
          org.gradle.daemon=true
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.configureondemand=true
          EOF
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: Run Lint & Unit Tests
        run: |
          set +e
          ./gradlew :app:lintDebug --stacktrace || echo "::warning::Lint failed"
          ./gradlew :app:testDebugUnitTest --stacktrace || echo "::warning::Tests failed"
          echo "âœ… Review stage complete"

  # ============================================================
  # ðŸ—ï¸ Build (always starts, waits if review enabled)
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: [review]
    if: ${{ always() || inputs.enable_review == false }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: android-actions/setup-android@v3
      - name: Configure Gradle (memory safe)
        run: |
          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError
          org.gradle.daemon=true
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.configureondemand=true
          EOF
      - name: Install Safe NDK
        run: |
          set -eux
          rm -rf "$ANDROID_SDK_ROOT/ndk" || true
          sdkmanager --update
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;$NDK_VERSION"
          test -d "$ANDROID_SDK_ROOT/ndk/$NDK_VERSION" || (echo "::error::NDK install failed" && exit 1)
      - name: Download Whisper Models
        run: |
          set -euo pipefail
          mkdir -p app/src/main/assets/models && cd app/src/main/assets/models
          download() {
            name="$1"; shift
            for u in "$@"; do
              echo "â†’ Trying $u"
              if curl -fSL -A "${CURL_UA}" --retry 3 --retry-delay 2 -o "$name" "$u"; then
                echo "âœ… $name downloaded ($(du -h "$name" | cut -f1))"
                return 0
              fi
            done
            echo "::error::Failed to fetch $name"
            return 1
          }
          download ggml-tiny-q5_1.bin https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny-q5_1.bin
          download ggml-base-q5_1.bin https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base-q5_1.bin
          download ggml-small-q5_1.bin https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small-q5_1.bin
          download ggml-model-q4_0.bin https://huggingface.co/jboat/jacaranda-asr-whispercpp/resolve/main/ggml-model-q4_0.bin
      - name: Build Release (memory-safe)
        run: |
          ./gradlew \
            -Pandroid.useAndroidX=true -Pandroid.enableJetifier=true \
            -Pandroid.ndkVersion=${NDK_VERSION} \
            :app:assembleRelease :app:bundleRelease \
            --no-daemon --stacktrace --info
      - id: collect
        run: |
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt
          echo "files<<EOF" >> "$GITHUB_OUTPUT"; cat outputs/files.txt >> "$GITHUB_OUTPUT"; echo "EOF" >> "$GITHUB_OUTPUT"
          echo "âœ… Collected $(wc -l < outputs/files.txt) artifact(s)"
      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

  # ============================================================
  # ðŸ§© Generate meta/models.json (for Wiki + Pages)
  # ============================================================
  meta:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Generate Model Meta
        run: |
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          cat > meta/models.json <<JSON
          {
            "generated": "${DATE}",
            "models": [
              {"name":"ggml-tiny-q5_1.bin","params":"39 M","size":"~32 MB","speed":"~32Ã— RT","notes":"Multilingual (EN/JP/SW)","source":"https://huggingface.co/ggerganov/whisper.cpp/blob/main/ggml-tiny-q5_1.bin"},
              {"name":"ggml-base-q5_1.bin","params":"74 M","size":"~57 MB","speed":"~16Ã— RT","notes":"Balanced multilingual","source":"https://huggingface.co/ggerganov/whisper.cpp/blob/main/ggml-base-q5_1.bin"},
              {"name":"ggml-small-q5_1.bin","params":"244 M","size":"~182 MB","speed":"~6Ã— RT","notes":"High accuracy","source":"https://huggingface.co/ggerganov/whisper.cpp/blob/main/ggml-small-q5_1.bin"},
              {"name":"ggml-model-q4_0.bin","params":"~769 M","size":"~444 MB","speed":"~3Ã— RT","notes":"Swahili-tuned","source":"https://huggingface.co/jboat/jacaranda-asr-whispercpp/blob/main/ggml-model-q4_0.bin"}
            ]
          }
          JSON
          echo "âœ… meta/models.json generated ($(wc -l < meta/models.json) lines)"
      - uses: actions/upload-artifact@v4
        with:
          name: meta
          path: meta/models.json

  # ============================================================
  # ðŸŒ Publish Pages + Wiki (Meta-Synced)
  # ============================================================
  publish:
    runs-on: ubuntu-latest
    needs: [meta]
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/
      - uses: actions/download-artifact@v4
        with:
          name: meta
          path: meta/
      - run: sudo apt-get update && sudo apt-get install -y jq
      - name: Generate Wiki + Pages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          QR_URL="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${BASE_URL}"
          mkdir -p wiki gh-pages/downloads
          echo "ðŸ“˜ Building Wiki (Markdown)..."
          {
            echo "# ðŸ“¦ WhispersCpp-Android Downloads"
            echo "Updated: ${DATE}\n"
            echo "## ðŸŽ§ Whisper Model Specifications"
            echo "| Model | Params | Size | Speed | Notes | Source |"
            echo "|:--|:--:|:--:|:--:|:--|:--|"
            jq -r '.models[] | "| \(.name) | \(.params) | \(.size) | \(.speed) | \(.notes) | [link](\(.source)) |"' meta/models.json
            echo "\n## âœ… Latest Artifacts"
            find artifacts -type f \( -name "*.apk" -o -name "*.aab" \) | sort | while read f; do
              N=$(basename "$f"); S=$(du -h "$f" | cut -f1); H=$(sha256sum "$f" | cut -d' ' -f1)
              echo "- [$N](https://github.com/${REPO}/releases/latest/download/$N) â€” $S  \`$H\`"
            done
            echo "\n## ðŸ•“ Release History"
            curl -s -H "Authorization: token ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/releases?per_page=20" | jq -r '.[] | "- [" + (.name // .tag_name) + "](" + .html_url + ") (" + (.published_at[0:10]) + ")"'
          } > wiki/Downloads.md
          echo "ðŸŒ Building Pages (HTML)..."
          cat > gh-pages/downloads/index.html <<HTML
          <!doctype html><html lang="en"><head><meta charset="utf-8">
          <title>ðŸ“¦ WhispersCpp-Android Downloads</title>
          <style>body{font-family:Inter,system-ui;background:#0f2027;color:#fff;text-align:center;padding:40px;}
          table{margin:auto;border-collapse:collapse;width:90%;}th,td{padding:6px 10px;border-bottom:1px solid #333;}
          a{color:#00eaff;text-decoration:none;}a:hover{text-decoration:underline;}
          </style></head><body>
          <h1>ðŸ“¦ WhispersCpp-Android Downloads</h1>
          <img src="${QR_URL}" width="160"><p><a href="${BASE_URL}">${BASE_URL}</a></p>
          <p>Updated: ${DATE}</p>
          <table><tr><th>Model</th><th>Params</th><th>Size</th><th>Speed</th><th>Notes</th><th>Source</th></tr>
          HTML
          jq -r '.models[] | "<tr><td>\(.name)</td><td>\(.params)</td><td>\(.size)</td><td>\(.speed)</td><td>\(.notes)</td><td><a href=\"\(.source)\">link</a></td></tr>"' meta/models.json >> gh-pages/downloads/index.html
          echo "</table><h2>Artifacts</h2><ul>" >> gh-pages/downloads/index.html
          find artifacts -type f \( -name "*.apk" -o -name "*.aab" \) -printf "<li><a href='https://github.com/${REPO}/releases/latest/download/%f'>%f</a></li>\n" >> gh-pages/downloads/index.html
          echo "</ul><footer><p>Generated ${DATE}</p></footer></body></html>" >> gh-pages/downloads/index.html
      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Update Pages (MetaSync)"
      - name: Push Wiki (master)
        run: |
          set -eux
          REPO="${{ github.repository }}"
          WIKI_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.wiki.git"
          git clone "$WIKI_URL" tempwiki
          cd tempwiki
          git checkout master || git checkout -b master
          cp ../wiki/Downloads.md .
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Downloads.md
          git commit -m "Auto-update Wiki (MetaSync ${DATE})" || echo "No changes"
          git push origin master --force
