# ============================================================
# ‚úÖ WhispersCpp-Android ‚Äî CI/CD (Final Stable v9.5.4 MetaAlways Edition)
# ------------------------------------------------------------
# ‚Ä¢ Build only when source changed
# ‚Ä¢ Meta + Publish always run (even if Build skipped)
# ‚Ä¢ Reuse last tag when no code changes
# ============================================================

name: Android CI & Release (Smart BuildSkip + MetaAlways)

on:
  workflow_dispatch:
    inputs:
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  CURL_UA: "curl/8.x (GitHub Actions; +https://github.com/actions)"
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709

# ============================================================
# üß† Detect Changes
# ============================================================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      last_tag: ${{ steps.tag.outputs.last_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: tag
        name: üîñ Get last release tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "ü™∂ Last tag: ${LAST_TAG:-<none>}"

      - id: check
        name: üîç Detect source changes
        run: |
          if [ -n "${{ steps.tag.outputs.last_tag }}" ]; then
            CHANGED=$(git diff --name-only ${{ steps.tag.outputs.last_tag }} HEAD app/ nativelib/ | wc -l)
          else
            CHANGED=1
          fi
          if [ "$CHANGED" -gt 0 ]; then
            echo "‚úÖ Source updated (${CHANGED} files changed)"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "üü° No source updates ‚Äî skipping Build, continuing Meta/Publish"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================
  # üß™ Review (optional)
  # ============================================================
  review:
    if: ${{ inputs.enable_review == true && needs.detect.outputs.changed == 'true' }}
    needs: detect
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: üß™ Run Lint + Unit Tests
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint failed"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Tests failed"

  # ============================================================
  # üèóÔ∏è Build (only if changed)
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: [detect, review]
    if: ${{ needs.detect.outputs.changed == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: android-actions/setup-android@v3
      - name: ‚öôÔ∏è Configure Gradle
        run: |
          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8
          org.gradle.daemon=true
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.configureondemand=true
          EOF
      - name: üß© Build Release
        run: |
          ./gradlew :app:assembleRelease :app:bundleRelease --stacktrace --info
      - id: collect
        run: |
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt
          echo "files<<EOF" >> "$GITHUB_OUTPUT"; cat outputs/files.txt >> "$GITHUB_OUTPUT"; echo "EOF" >> "$GITHUB_OUTPUT"
      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

  # ============================================================
  # üß© Meta (always runs)
  # ============================================================
  meta:
    runs-on: ubuntu-latest
    needs: [detect]
    if: ${{ always() }}
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: tag
        name: üè∑Ô∏è Generate or reuse tag
        run: |
          if [ "${{ needs.detect.outputs.changed }}" == "true" ]; then
            TAG="v9.5.4-$(date '+%Y%m%d-%H%M')"
            echo "üÜï New tag: $TAG"
            git tag -a "$TAG" -m "Auto-tag for updated source"
            git push origin "$TAG"
          else
            TAG="${{ needs.detect.outputs.last_tag }}"
            echo "‚ôªÔ∏è Reusing tag: $TAG"
          fi
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"

      - name: üß† Generate Metadata
        run: |
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          echo "{
            \"generated\": \"${DATE}\",
            \"version_tag\": \"${{ steps.tag.outputs.tag_name }}\"
          }" > meta/models.json
      - uses: actions/upload-artifact@v4
        with:
          name: meta
          path: meta/models.json

  # ============================================================
  # üåê Publish (always runs)
  # ============================================================
  publish:
    runs-on: ubuntu-latest
    needs: [meta]
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: meta
          path: meta/
      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/
          continue-on-error: true
      - run: sudo apt-get update && sudo apt-get install -y jq

      - name: üìò Generate Wiki + Pages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ needs.meta.outputs.tag_name }}
          DATE=$(date '+%Y-%m-%d %H:%M')
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages/downloads

          echo "# üì¶ WhispersCpp-Android (${TAG})" > wiki/Downloads.md
          echo "Updated: ${DATE}\n" >> wiki/Downloads.md
          echo "## üß† Metadata" >> wiki/Downloads.md
          jq . meta/models.json >> wiki/Downloads.md

          echo "\n## üïì Release History" >> wiki/Downloads.md
          curl -s -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/releases?per_page=20" | \
            jq -r '.[] | select(.tag_name != null) | "- [" + .tag_name + "](" + .html_url + ") (" + (.published_at[0:10] // "") + ")"' | sort -r >> wiki/Downloads.md

          echo "‚úÖ Wiki updated (${TAG})"

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Update Pages (MetaSync ${TAG})"

      - name: üìù Push Wiki (master)
        run: |
          REPO="${{ github.repository }}"
          WIKI_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.wiki.git"
          git clone "$WIKI_URL" tempwiki
          cd tempwiki
          git checkout master || git checkout -b master
          cp ../wiki/Downloads.md .
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Downloads.md
          git commit -m "Auto-update Wiki (${TAG})" || echo "No changes"
          git push origin master --force
