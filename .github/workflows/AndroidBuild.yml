# ============================================================
# ‚úÖ WhispersCpp-Android ‚Äî Full CI/CD Automation (Final Stable v8.6.7g)
# ------------------------------------------------------------
# ‚Ä¢ Trigger: workflow_dispatch „ÅÆ„Åø
# ‚Ä¢ q4_0: PRIMARY = HF(jboat) ‚Üí FALLBACK = Release(v1.0-2025-1101)  ‚Äªtry/raw ‰∏ç‰ΩøÁî®
# ‚Ä¢ tiny/base/small: HF ‚Üí upstreamÔºàÂ≠òÂú®„Åô„Çã„Éë„Çπ„ÅÆ„ÅøÔºèbase„ÅØ base.bin „ÇÇË®±ÂÆπÔºâ
# ‚Ä¢ GET ÂÆü„Çµ„Ç§„Ç∫„ÅßÂà§ÂÆöÔºàHEAD„ÅØÂèÇËÄÉÔºâ+ ‰ªªÊÑè SHA256 Ê§úË®º
# ‚Ä¢ AndroidX Âº∑Âà∂Ôºà‰∫åÈáçÂåñÔºâ/ Gradle Cache / Fancy Pages / Wiki ÂêåÊúü
# ‚Ä¢ ‰øÆÊ≠£: $GITHUB_OUTPUT „ÅÆ EOF Âå∫Âàá„ÇäÂ≠ê„Éê„Ç∞„ÇíËß£Ê∂àÔºà„ÇØ„Ç©„Éº„ÉàÁÑ°„Åó EOF„ÉªË°åÈ†≠„ÉªÂçòÁã¨Ë°åÔºâ
# ============================================================

name: Android CI & Release (Full + Fancy Pages + Wiki)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      create_release:
        description: "Publish GitHub Release + Pages + Wiki"
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  MODEL_RELEASE_TAG: v1.0-2025-1101
  CURL_UA: "curl/8.x (GitHub Actions; +https://github.com/actions)"
  # ‰ªªÊÑè: ÊúüÂæÖSHA„ÇíË®≠ÂÆö„Åô„Çã„Å®Êï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüÊñΩÔºàÊú™Ë®≠ÂÆö„Å™„Çâ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
  # MODEL_Q40_SHA256: ""
  # MODEL_TINY_SHA256: ""
  # MODEL_BASE_SHA256: ""
  # MODEL_SMALL_SHA256: ""

# ============================================================
# üß† Review
# ============================================================
jobs:
  review:
    runs-on: ubuntu-latest
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME || github.ref_name }}

      # AndroidX „Çí„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁõ¥‰∏ã„ÅßÂº∑Âà∂ÔºàÂæåÁ∂ö„Ç∏„Éß„Éñ„Åß„ÇÇÂÜ™Á≠âÔºâ
      - name: Enforce AndroidX (project gradle.properties)
        run: |
          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.caching=true
          EOF
          echo "== gradle.properties ==" && cat gradle.properties

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Lint & UnitTest (non-blocking with warnings)
        run: |
          ./gradlew -Pandroid.useAndroidX=true -Pandroid.enableJetifier=true :app:lintDebug || echo "::warning::Lint failed (continuing)"
          ./gradlew -Pandroid.useAndroidX=true -Pandroid.enableJetifier=true :app:testDebugUnitTest || echo "::warning::Unit tests failed (continuing)"

  # ============================================================
  # üèóÔ∏è Build & Release
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: review
    env:
      MODULE_PATH: app
      BRANCH_NAME: ${{ inputs.branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME || github.ref_name }}
          fetch-depth: 0
          lfs: false
          submodules: recursive

      - name: Enforce AndroidX (project gradle.properties)
        run: |
          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.caching=true
          EOF

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties','**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Gradle user properties
        run: |
          mkdir -p ~/.gradle
          cat <<'EOF' > ~/.gradle/gradle.properties
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.caching=true
          EOF

      # ----------------------- Models ------------------------
      - name: Download Whisper models (robust; no try/raw)
        env:
          # ‰øùÂ≠òÂêç
          M_Q40:  ggml-model-q4_0.bin
          M_TINY: ggml-tiny-q5_1.bin
          M_BASE: ggml-base-q5_1.bin
          M_SMALL: ggml-small-q5_1.bin

          # q4_0: HF(jboat) ‚Üí Release(tag)
          U_HF_Q40:  https://huggingface.co/jboat/jacaranda-asr-whispercpp/resolve/main/ggml-model-q4_0.bin
          U_REL_Q40: ${{ format('https://github.com/{0}/releases/download/{1}/ggml-model-q4_0.bin', github.repository, env.MODEL_RELEASE_TAG) }}

          # tiny/base/small: HF ‚Üí upstreamÔºàÂ≠òÂú®„Åô„Çã„Éë„Çπ„ÅÆ„ÅøÔºâ
          # tiny
          U_HF_TINY:   https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny-q5_1.bin
          U_UP_TINY:   https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-tiny-q5_1.bin

          # base: Ë§áÊï∞ÂÄôË£úÔºàq5_1 / en-q5_1 / base.binÔºâ
          U_HF_BASE_Q51:    https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base-q5_1.bin
          U_HF_BASE_EN_Q51: https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en-q5_1.bin
          U_HF_BASE_BIN:    https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin
          U_UP_BASE_BIN:    https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-base.bin

          # small
          U_HF_SMALL:  https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small-q5_1.bin
          U_UP_SMALL:  https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-small-q5_1.bin
        run: |
          set -euo pipefail
          mkdir -p app/src/main/assets/models
          cd app/src/main/assets/models

          echo "üì¶ Whisper ggml models ‚Äî HEAD„ÅØÂèÇËÄÉ„ÄÅÊúÄÁµÇÂà§ÂÆö„ÅØGET„Çµ„Ç§„Ç∫Ôºè‰ªªÊÑèSHA"
          echo "  MODEL_RELEASE_TAG=${MODEL_RELEASE_TAG}"

          # ÂÆü„Çµ„Ç§„Ç∫„ÅÆ‰∏ãÈôêÔºàq5_1„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥Ôºâ
          MIN_Q40=$((60 * 1024 * 1024))     # 60MB
          MIN_TINY=$((20 * 1024 * 1024))    # 20MB  (tiny q5_1 ÊÉ≥ÂÆö)
          MIN_BASE=$((55 * 1024 * 1024))    # 55MB  (base q5_1 ÂÆüÊ∏¨ ~57MB)
          MIN_SMALL=$((180 * 1024 * 1024))  # 180MB (small q5_1 ÊÉ≥ÂÆö)

          head_size () { curl -fsSIL -A "${CURL_UA}" -L "$1" | awk '/[Cc]ontent-[Ll]ength/ {print $2}' | tr -d '\r' || true; }
          curl_dl () { curl -fSL -A "${CURL_UA}" --retry 5 --retry-delay 2 -o "$2" "$1"; }
          sha_check () { [ -z "${2:-}" ] && return 0; got=$(sha256sum "$1"|awk '{print $1}'); [ "$got" = "$2" ] || { echo "::error::SHA256 mismatch for $1 (got=$got expect=$2)"; return 1; }; echo "‚úÖ SHA256 OK for $1"; }
          download_chain () {
            local name="$1" min="$2"; shift 2; local urls=("$@")
            for u in "${urls[@]}"; do
              [ -z "$u" ] && continue
              echo "üì• $name ‚Üê $u"
              szh=$(head_size "$u" || true); [ -n "$szh" ] && echo "   HEAD Content-Length=$szh (min=$min) ‚ÄªÂèÇËÄÉ" || echo "   HEAD=NA ‚Üí GET„ÅßÂà§ÂÆö"
              if curl_dl "$u" "${name}.tmp"; then
                sz=$(wc -c < "${name}.tmp" || echo 0); echo "   GET size=$sz (min=$min)"
                if [ "$sz" -ge "$min" ]; then mv "${name}.tmp" "$name"; echo "‚úÖ $name OK (from $u)"; return 0; fi
                echo "   too small ‚Üí next"; rm -f "${name}.tmp"
              else echo "   download failed ‚Üí next"; rm -f "${name}.tmp" || true; fi
            done; return 1
          }

          # q4_0: HF(jboat) ‚Üí Release(tag)
          download_chain "${M_Q40}"  "${MIN_Q40}"  "${U_HF_Q40}"  "${U_REL_Q40}"  || { echo "::error::${M_Q40} fetch failed";  exit 1; }
          [ -n "${MODEL_Q40_SHA256:-}" ] && sha_check "${M_Q40}" "${MODEL_Q40_SHA256}"

          # tiny: HF ‚Üí upstream
          download_chain "${M_TINY}" "${MIN_TINY}" "${U_HF_TINY}" "${U_UP_TINY}" || { echo "::error::${M_TINY} failed";  exit 1; }
          [ -n "${MODEL_TINY_SHA256:-}" ] && sha_check "${M_TINY}" "${MODEL_TINY_SHA256}"

          # base: HF(q5_1 / en-q5_1 / base.bin) ‚Üí upstream(base.bin)
          #   ‚Äª ‰øùÂ≠òÂêç„ÅØ M_BASE(=ggml-base-q5_1.bin) „Å´Áµ±‰∏Ä
          if download_chain "${M_BASE}" "${MIN_BASE}" \
               "${U_HF_BASE_Q51}" "${U_HF_BASE_EN_Q51}" "${U_HF_BASE_BIN}" "${U_UP_BASE_BIN}"; then
            [ -n "${MODEL_BASE_SHA256:-}" ] && sha_check "${M_BASE}" "${MODEL_BASE_SHA256}"
          else
            echo "::error::${M_BASE} download failed (tried q5_1/en-q5_1/base.bin variants)"; exit 1
          fi

          # small: HF ‚Üí upstream
          download_chain "${M_SMALL}" "${MIN_SMALL}" "${U_HF_SMALL}" "${U_UP_SMALL}" || { echo "::error::${M_SMALL} failed"; exit 1; }
          [ -n "${MODEL_SMALL_SHA256:-}" ] && sha_check "${M_SMALL}" "${MODEL_SMALL_SHA256}"

          echo "--- Downloaded files ---"; ls -lh

      - name: Build Release
        env:
          ORG_GRADLE_PROJECT_android_useAndroidX: "true"
          ORG_GRADLE_PROJECT_android_enableJetifier: "true"
        run: |
          set -euo pipefail
          ./gradlew -Pandroid.useAndroidX=true -Pandroid.enableJetifier=true :${{ env.MODULE_PATH }}:clean :${{ env.MODULE_PATH }}:assembleRelease :${{ env.MODULE_PATH }}:bundleRelease --stacktrace --no-daemon

      - id: collect
        name: Collect artifacts (APK/AAB + SHA256)
        run: |
          set -euo pipefail
          mkdir -p outputs
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) | sort > outputs/files.txt
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          cat outputs/files.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "Collected files:"; cat outputs/files.txt
          echo "--- SHA256 SUMS ---"; xargs -a outputs/files.txt -r sha256sum

      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: ${{ steps.collect.outputs.files }}
          retention-days: 7

      - id: version
        name: Extract versionName
        run: |
          set -euo pipefail
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

      - id: release
        name: Prepare release notes
        run: |
          set -euo pipefail
          TAG="v${{ steps.version.outputs.version }}-$(date '+%Y%m%d-%H%M')"
          NOTES="$(git log -10 --pretty='* %s (%an)' || true)"
          {
            echo "tag=$TAG"
            echo "body<<EOF"
            echo "## What's Changed"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - uses: softprops/action-gh-release@v2
        if: ${{ inputs.create_release == true }}
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: "WhispersCpp Release ${{ steps.version.outputs.version }}"
          body: ${{ steps.release.outputs.body }}
          files: ${{ steps.collect.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # üåê GitHub Pages ‚Äî Fancy Glass UI
  # ============================================================
  pages:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/

      - name: Generate fancy downloads HTML (and copy artifacts)
        run: |
          set -euo pipefail
          mkdir -p gh-pages/downloads
          while IFS= read -r f; do
            [ -f "$f" ] || continue
            cp -f "$f" "gh-pages/downloads/$(basename "$f")"
          done < <(find artifacts -type f \( -name "*.apk" -o -name "*.aab" \) | sort)

          GEN_TIME=$(date '+%Y-%m-%d %H:%M')
          cat > gh-pages/downloads/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
          <title>üì¶ WhispersCpp-Android Downloads</title>
          <style>
            body{font-family:Inter,system-ui;text-align:center;margin:0;padding:40px;background:linear-gradient(145deg,#0f2027,#203a43,#2c5364);color:#fff;}
            h1{margin-bottom:12px;}
            .card{backdrop-filter:blur(14px);background:rgba(255,255,255,0.07);border-radius:20px;padding:22px;margin:20px auto;width:80%;max-width:740px;box-shadow:0 8px 32px rgba(0,0,0,.35);}
            ul{list-style:none;padding:0;margin:0;} li{margin:8px 0;}
            a{color:#00eaff;text-decoration:none;font-weight:600;} a:hover{text-decoration:underline;}
            code{background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:6px;cursor:pointer;}
            footer{opacity:.7;margin-top:30px;font-size:.8em;}
          </style>
          <script>function copySHA(sha){navigator.clipboard.writeText(sha);alert("SHA256 copied:\\n"+sha);}</script>
          </head><body>
          <h1>üì¶ WhispersCpp-Android Downloads</h1>
          <p>Generated: ${GEN_TIME}</p>
          <div class="card"><h2>Release Artifacts</h2><ul>
          HTML

          for f in $(find gh-pages/downloads -maxdepth 1 -type f \( -name "*.apk" -o -name "*.aab" \) -printf "%f\n" | sort); do
            SIZE=$(du -h "gh-pages/downloads/$f" | cut -f1)
            SHA=$(sha256sum "gh-pages/downloads/$f" | cut -d' ' -f1)
            echo "<li><a href='$f'>$f</a> ‚Äî $SIZE <code onclick=\"copySHA('$SHA')\">$SHA</code></li>" >> gh-pages/downloads/index.html
          done

          echo "</ul></div><footer>Generated automatically ‚Ä¢ ${GEN_TIME}</footer></body></html>" >> gh-pages/downloads/index.html

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages/downloads
          publish_branch: gh-pages
          commit_message: "Update fancy downloads page ($(date '+%Y-%m-%d %H:%M'))"

  # ============================================================
  # üìò Wiki Sync
  # ============================================================
  wiki:
    runs-on: ubuntu-latest
    needs: pages
    if: ${{ inputs.create_release == true }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/

      - name: Clone Wiki (skip if not exists)
        run: |
          if ! git ls-remote "https://github.com/${{ github.repository }}.wiki.git" &> /dev/null; then
            echo "‚ö†Ô∏è Wiki not found; skipping."; exit 0; fi
          git clone "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki

      - name: Update Downloads.md
        run: |
          set -euo pipefail
          cd wiki
          echo "# üì¶ WhispersCpp-Android Downloads" > Downloads.md
          echo "Updated: $(date '+%Y-%m-%d %H:%M')" >> Downloads.md
          echo "" >> Downloads.md
          find ../artifacts -type f \( -name "*.apk" -o -name "*.aab" \) -print0 \
            | sort -z \
            | while IFS= read -r -d '' f; do
                N=$(basename "$f"); S=$(du -h "$f"|cut -f1); H=$(sha256sum "$f"|cut -d' ' -f1)
                echo "- [$N](https://github.com/${{ github.repository }}/releases/latest/download/$N) ‚Äî $S  \`$H\`" >> Downloads.md
              done
          git add Downloads.md
          git commit -m "Auto-update Downloads ($(date '+%Y-%m-%d %H:%M'))" || true
          git pull --rebase || true
          git push origin master || git push origin main || true
