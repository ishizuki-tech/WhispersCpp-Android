name: Android CI & Release (Final Stable + Asset Safe + LFS Verified)

on:
  workflow_dispatch:
    inputs:
      module:
        description: "Android module to build (e.g. app)"
        default: "app"
      create_release:
        description: "Publish GitHub Release with built artifacts"
        type: boolean
        default: true
      ndk_version:
        description: "Android NDK version"
        default: "28.0.12433566"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 70

    env:
      MODULE_PATH: ${{ inputs.module || 'app' }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ORG_GRADLE_PROJECT_releaseStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ORG_GRADLE_PROJECT_releaseKeyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
      ORG_GRADLE_PROJECT_releaseKeyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      # =======================================================
      # ‚úÖ Checkout with LFS & Submodules
      # =======================================================
      - name: Checkout repository (LFS + submodules)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GH_TOKEN }}

      - name: Verify LFS-tracked files
        run: |
          echo "üì¶ Verifying LFS files..."
          git lfs ls-files || echo "‚ö†Ô∏è No LFS files detected"
          echo "üìÅ Model asset sizes:"
          ls -lh app/src/main/assets/models || true
          echo "‚úÖ LFS check complete."

      # =======================================================
      # üß© whisper.cpp Patch
      # =======================================================
      - name: Remove non-Android ggml backends
        run: |
          echo "üßπ Removing non-Android backends (CUDA/Metal/etc)..."
          rm -rf nativelib/whisper.cpp/ggml/src/ggml-{cuda,metal,cann,opencl,blas} || true
          echo "‚úÖ CPU-only configuration set."

      # =======================================================
      # üîß Android SDK & JDK
      # =======================================================
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Install Android SDK & NDK
        uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ inputs.ndk_version }}

      - name: Install Android platform & build-tools
        run: |
          echo "üì¶ Installing build-tools..."
          sdkmanager --install "platforms;android-35" "build-tools;35.0.0" "platform-tools" || true
          yes | sdkmanager --licenses > /dev/null 2>&1 || true
          echo "‚úÖ Android SDK/NDK ready."

      - name: Print environment summary
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME"
          echo "PATH=$PATH"

      # =======================================================
      # üìÅ Asset Validation
      # =======================================================
      - name: Validate assets/models existence
        run: |
          echo "üìÇ Checking app/src/main/assets/models ..."
          mkdir -p app/src/main/assets/models
          FILE_COUNT=$(find app/src/main/assets/models -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "::error::No model files detected in assets/models (did you commit via LFS?)"
            exit 1
          fi
          echo "‚úÖ Found $FILE_COUNT model file(s)."
          ls -lh app/src/main/assets/models
          echo "üîç SHA1 checksums:"
          sha1sum app/src/main/assets/models/* || true

      # =======================================================
      # üß∞ Gradle setup
      # =======================================================
      - name: Configure Gradle caching
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-home-cache-strategy: gradle-user-home

      - name: Write gradle.properties
        run: |
          mkdir -p "$HOME/.gradle"
          cat > "$HOME/.gradle/gradle.properties" <<'PROPS'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.caching=true
          org.gradle.configuration-cache=true
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          PROPS
          echo "‚úÖ Gradle caching enabled."

      # =======================================================
      # üîê Keystore
      # =======================================================
      - name: Decode Android keystore
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > keystore.jks
          echo "ANDROID_KEYSTORE_FILE=$PWD/keystore.jks" >> $GITHUB_ENV
          echo "‚úÖ Keystore decoded."

      # =======================================================
      # üß© Verify JNI
      # =======================================================
      - name: Verify JNI structure
        run: |
          echo "üîç Checking JNI/CMake..."
          find nativelib/src/main -maxdepth 5 -type f \( -name 'CMakeLists.txt' -o -name '*.cpp' \) | head -n 15
          test -f nativelib/src/main/jni/whisper/CMakeLists.txt || { echo "::error::Missing JNI CMakeLists.txt"; exit 1; }
          echo "‚úÖ JNI verified."

      # =======================================================
      # üß† Build
      # =======================================================
      - name: Print Gradle projects
        run: ./gradlew projects --no-daemon

      - name: Build release artifacts
        run: |
          set -e
          echo "üöÄ Building module: $MODULE_PATH"
          ./gradlew :${MODULE_PATH}:clean :${MODULE_PATH}:assembleRelease :${MODULE_PATH}:bundleRelease --stacktrace --info
          echo "‚úÖ Build complete."

      # =======================================================
      # üì¶ Collect Outputs
      # =======================================================
      - name: Collect build outputs
        id: collect
        run: |
          ROOT="${MODULE_PATH}/build/outputs"
          APKs=$(find "$ROOT" -type f -name '*.apk' | sort || true)
          AABs=$(find "$ROOT" -type f -name '*.aab' | sort || true)
          echo "Found APKs:"; echo "$APKs"
          echo "Found AABs:"; echo "$AABs"
          {
            echo "apk_list<<EOF"
            echo "${APKs:-}"
            echo "EOF"
            echo "aab_list<<EOF"
            echo "${AABs:-}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # =======================================================
      # üîç Inspect APK contents
      # =======================================================
      - name: Inspect assets inside APK
        run: |
          echo "üîç Inspecting built APKs..."
          for f in $(find app/build/outputs -name "*.apk"); do
            echo "---------------------------------------"
            ls -lh "$f"
            unzip -l "$f" | grep "assets/models" || echo "‚ö†Ô∏è No models found in $f!"
            echo "---------------------------------------"
          done

      # =======================================================
      # ‚òÅÔ∏è Upload artifacts
      # =======================================================
      - name: Upload APKs
        if: ${{ steps.collect.outputs.apk_list != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: ${{ steps.collect.outputs.apk_list }}
          retention-days: 14

      - name: Upload AABs
        if: ${{ steps.collect.outputs.aab_list != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: ${{ steps.collect.outputs.aab_list }}
          retention-days: 14

      # =======================================================
      # üè∑Ô∏è Version & Release
      # =======================================================
      - name: Derive version
        id: version
        run: |
          FILE="${MODULE_PATH}/build.gradle.kts"
          VERSION=$(grep -E 'versionName' "$FILE" | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "‚úÖ versionName: $VERSION"

      - name: Compute release tag
        id: tag
        run: |
          TS=$(date '+%Y%m%d-%H%M')
          TAG="v${{ steps.version.outputs.version }}-${TS}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "üè∑Ô∏è Tag: $TAG"

      - name: Prepare release notes
        id: notes
        run: |
          NOTES=$(git log -15 --pretty='* %s (%an)')
          {
            echo "body<<EOF"
            echo "## What's Changed"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Publish GitHub Release
        if: ${{ inputs.create_release && (steps.collect.outputs.apk_list != '' || steps.collect.outputs.aab_list != '') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body: ${{ steps.notes.outputs.body }}
          files: |
            ${{ steps.collect.outputs.apk_list }}
            ${{ steps.collect.outputs.aab_list }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Skip release
        if: ${{ !inputs.create_release }}
        run: echo "Release skipped."
